<!DOCTYPE html>
<html lang="{{ lang }}" {{ 'dir="rtl"' if lang in ['ar', 'he'] else '' }}>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ i18n.t('DASHBOARD_TITLE', lang) }}</title>
	<link rel="apple-touch-icon" sizes="180x180" href="/Assets/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/Assets/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/Assets/favicon-16x16.png">
	<link rel="manifest" href="/Assets/site.webmanifest">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="/Assets/styles.css">
</head>
<body>
	<div class="particles" id="particles-js"></div>
	<div class="language-switcher">
		<select onchange="window.location.href='/' + this.value">
			{% for code in ['en', 'tr', 'ar', 'he', 'la'] %}
				<option value="{{ code }}" {{ 'selected' if code == lang else '' }}>{{ i18n.t('LANGUAGE_NAME_' + code.upper(), lang) }}</option>
			{% endfor %}
		</select>
	</div>
	<div class="logo-container">
		<div class="logo">NumberFansBot</div>
		<div class="tagline">{{ i18n.t('TAGLINE', lang) }}</div>
	</div>
	<div class="status-container">
		<h2>{{ i18n.t('DASHBOARD_TITLE', lang) }}</h2>
		{% with messages = get_flashed_messages(with_categories=true) %}
			{% if messages %}
				{% for category, message in messages %}
					<div class="alert {{ 'alert-success' if category == 'success' else 'alert-danger' }}">{{ message }}</div>
				{% endfor %}
			{% endif %}
		{% endwith %}
		<div class="tabs">
			<div class="tab active" data-tab="config">{{ i18n.t('CONFIG_TAB', lang) }}</div>
			<div class="tab" data-tab="users">{{ i18n.t('USERS_TAB', lang) }}</div>
			<div class="tab" data-tab="github">{{ i18n.t('GITHUB_TRAFFIC_TAB', lang) }}</div>
		</div>
		<div class="tab-content active" id="config">
			<h3>{{ i18n.t('CONFIG_TITLE', lang) }}</h3>
			<form method="POST" action="{{ url_for('save_config_route', lang=lang) }}">
				<h4>{{ i18n.t('STANDARD_SETTINGS', lang) }}</h4>
				{% for field in fields if not field.key.startswith('ai_settings.') %}
					<div class="mb-3">
						<label for="{{ field.key }}" class="form-label">{{ field.label }}</label>
						<input type="text" class="form-control" id="{{ field.key }}" name="{{ field.key }}" value="{{ field.value }}">
						{% if field.use_env %}
							<div class="form-check mt-2">
								<input type="checkbox" class="form-check-input" id="{{ field.key }}_use_env" name="{{ field.key }}_use_env" {{ 'checked' if field.use_env else '' }}>
								<label class="form-check-label" for="{{ field.key }}_use_env">{{ i18n.t('USE_ENV', lang) }}</label>
								<small class="text-muted">{{ i18n.t('TOOLTIP_ENV', lang) }}</small>
							</div>
						{% endif %}
					</div>
				{% endfor %}
				<h4>{{ i18n.t('AI_SETTINGS', lang) }}</h4>
				{% for field in fields if field.key.startswith('ai_settings.') %}
					<div class="mb-3">
						<label for="{{ field.key }}" class="form-label">{{ field.label }}</label>
						<input type="text" class="form-control" id="{{ field.key }}" name="{{ field.key }}" value="{{ field.value }}">
						{% if field.use_env %}
							<div class="form-check mt-2">
								<input type="checkbox" class="form-check-input" id="{{ field.key }}_use_env" name="{{ field.key }}_use_env" {{ 'checked' if field.use_env else '' }}>
								<label class="form-check-label" for="{{ field.key }}_use_env">{{ i18n.t('USE_ENV', lang) }}</label>
								<small class="text-muted">{{ i18n.t('TOOLTIP_ENV', lang) }}</small>
							</div>
						{% endif %}
					</div>
				{% endfor %}
				<h4>AI Models</h4>
				<table class="table table-dark table-striped">
					<thead>
						<tr>
							<th>Name</th>
							<th>URL</th>
							<th>Access Token Env</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for name, model in config.models.items() %}
							<tr>
								<td>{{ model.name }}</td>
								<td>{{ model.url }}</td>
								<td>{{ model.access_token_env }}</td>
								<td>
									<form method="POST" action="{{ url_for('delete_model', lang=lang) }}" style="display:inline;">
										<input type="hidden" name="model_name" value="{{ model.name }}">
										<button type="submit" class="btn btn-danger btn-sm">Delete</button>
									</form>
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
				<h5>Add New Model</h5>
				<form method="POST" action="{{ url_for('add_model', lang=lang) }}">
					<div class="mb-3">
						<label for="model_name" class="form-label">Model Name</label>
						<input type="text" class="form-control" id="model_name" name="model_name" required>
					</div>
					<div class="mb-3">
						<label for="model_url" class="form-label">Model URL</label>
						<input type="text" class="form-control" id="model_url" name="model_url" required>
					</div>
					<div class="mb-3">
						<label for="access_token_env" class="form-label">Access Token Environment Variable</label>
						<input type="text" class="form-control" id="access_token_env" name="access_token_env" required>
					</div>
					<button type="submit" class="btn btn-primary">Add Model</button>
				</form>
				<button type="submit" class="btn btn-primary mt-3">{{ i18n.t('SAVE_CONFIG', lang) }}</button>
			</form>
		</div>
		<div class="tab-content" id="users">
			<h3>{{ i18n.t('USERS_TAB', lang) }}</h3>
			<h4>Manage Beta Testers</h4>
			<form method="POST" action="{{ url_for('manage_beta_tester', lang=lang) }}">
				<div class="mb-3">
					<label for="telegram_id" class="form-label">Telegram ID</label>
					<input type="text" class="form-control" id="telegram_id" name="telegram_id" placeholder="Enter Telegram ID" required>
				</div>
				<div class="mb-3">
					<button type="submit" name="action" value="grant" class="btn btn-success">Grant Beta Tester</button>
					<button type="submit" name="action" value="revoke" class="btn btn-warning">Revoke Beta Tester</button>
				</div>
			</form>
			<h4>User List</h4>
			<table class="table table-dark table-striped">
				<thead>
					<tr>
						<th>{{ i18n.t('USER_ID', lang) }}</th>
						<th>{{ i18n.t('USERNAME', lang) }}</th>
						<th>{{ i18n.t('FIRST_NAME', lang) }}</th>
						<th>{{ i18n.t('LAST_INTERACTION', lang) }}</th>
						<th>Beta Tester</th>
						<th>Credits</th>
					</tr>
				</thead>
				<tbody>
					{% for user in users %}
						<tr>
							<td>{{ user['_id'] }}</td>
							<td>{{ user['username'] or 'N/A' }}</td>
							<td>{{ user['first_name'] or 'N/A' }}</td>
							<td>{{ user['last_interaction'].strftime('%Y-%m-%d %H:%M:%S') if user.get('last_interaction') else 'N/A' }}</td>
							<td>{{ 'Yes' if user.get('is_beta_tester') else 'No' }}</td>
							<td>{{ user.get('credits', 0) }}</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		<div class="tab-content" id="github">
			<h3>{{ i18n.t('GITHUB_TRAFFIC_TAB', lang) }}</h3>
			<a href="{{ url_for('github_traffic', lang=lang) }}" class="btn btn-primary">{{ i18n.t('VIEW_GITHUB_TRAFFIC', lang) }}</a>
		</div>
		<a href="{{ url_for('logout', lang=lang) }}" class="btn btn-secondary mt-3">{{ i18n.t('LOGOUT_SUCCESS', lang) }}</a>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
	<script>
		particlesJS('particles-js', {
			"particles": {
				"number": {"value": 80, "density": {"enable": true, "value_area": 800}},
				"color": {"value": "#ffffff"},
				"shape": {"type": "circle"},
				"opacity": {"value": 0.5, "random": true, "anim": {"enable": true, "speed": 1, "opacity_min": 0.1, "sync": false}},
				"size": {"value": 3, "random": true, "anim": {"enable": true, "speed": 2, "size_min": 0.1, "sync": false}},
				"line_linked": {"enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.4, "width": 1},
				"move": {"enable": true, "speed": 2, "direction": "none", "random": true, "straight": false, "out_mode": "out", "bounce": false, "attract": {"enable": true, "rotateX": 600, "rotateY": 1200}}
			},
			"interactivity": {
				"detect_on": "canvas",
				"events": {"onhover": {"enable": true, "mode": "grab"}, "onclick": {"enable": true, "mode": "push"}, "resize": true},
				"modes": {"grab": {"distance": 140, "line_linked": {"opacity": 1}}, "push": {"particles_nb": 4}}
			},
			"retina_detect": true
		});

		document.querySelectorAll('.tab').forEach(tab => {
			tab.addEventListener('click', () => {
				document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
				document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
				tab.classList.add('active');
				document.getElementById(tab.dataset.tab).classList.add('active');
			});
		});
	</script>
</body>
</html>