<!DOCTYPE html>
<html lang="{{ lang }}" {{ 'dir="rtl"' if lang in ['ar', 'he'] else '' }}>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ i18n.t('DASHBOARD_TITLE', lang) }}</title>
	<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
	<link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
	<link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
	<link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
	<div class="particles" id="particles-js"></div>
	<div class="language-switcher">
		<select onchange="window.location.href='/' + this.value">
			{% for code in ['en', 'tr', 'ar', 'he', 'la'] %}
				<option value="{{ code }}" {{ 'selected' if code == lang else '' }}>{{ i18n.t('LANGUAGE_NAME_' + code.upper(), lang) }}</option>
			{% endfor %}
		</select>
	</div>
	<div class="logo-container">
		<div class="logo">NumberFansBot</div>
		<div class="tagline">{{ i18n.t('TAGLINE', lang) }}</div>
	</div>
	<div class="status-container">
		<h2>{{ i18n.t('DASHBOARD_TITLE', lang) }}</h2>
		{% with messages = get_flashed_messages(with_categories=true) %}
			{% if messages %}
				{% for category, message in messages %}
					<div class="alert {{ 'alert-success' if category == 'success' else 'alert-danger' }}">{{ message }}</div>
				{% endfor %}
			{% endif %}
		{% endwith %}
		<div class="tabs">
			{% if command_usage %}<div class="tab active" data-tab="commands">{{ i18n.t('COMMANDS_TAB', lang) }}</div>{% else %}{% endif %}
			<div class="tab {% if not command_usage %}active{% else %}{% endif %}" data-tab="config">{{ i18n.t('CONFIG_TAB', lang) }}</div>
			<div class="tab" data-tab="users">{{ i18n.t('USERS_TAB', lang) }}</div>
			{% if github_info.url %}<div class="tab" data-tab="github">{{ i18n.t('GITHUB_TRAFFIC_TAB', lang) }}</div>{% else %}{% endif %}
			<div class="tab" data-tab="install">{{ i18n.t('INSTALL_TAB', lang) }}</div>
		</div>
		<div class="tab-content" id="install">
			<h3>{{ i18n.t('INSTALL_TITLE', lang) }}</h3>
			<a href="{{ url_for('install', lang=lang) }}" class="btn btn-primary">{{ i18n.t('GO_TO_INSTALL', lang) }}</a>
		</div>
		<div class="tab-content" id="commands">
		<h2>{{ i18n.t('COMMANDS_TITLE', lang) }}</h2>
		<p>{{ i18n.t('COMMANDS_DESCRIPTION', lang) }}</p>
		{% if command_usage %}
			<table class="table table-dark table-striped">
				<thead>
					<tr>
						<th>{{ i18n.t('COMMAND_NAME', lang) }}</th>
						<th>{{ i18n.t('USAGE_COUNT', lang) }}</th>
						<th>{{ i18n.t('LAST_USED', lang) }}</th>
						<th>{{ i18n.t('LAST_USER', lang) }}</th>
					</tr>
				</thead>
				<tbody>
					{% for usage in command_usage %}
						<tr>
							<td>/{{ usage['command'] }}</td>
							<td>{{ usage['count'] }}</td>
							<td>{{ usage['last_used'].strftime('%Y-%m-%d %H:%M:%S') if usage.get('last_used') else 'N/A' }}</td>
							<td>{{ usage['last_user_id'] if usage.get('last_user_id') else 'N/A' }}</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		{% else %}
		{% endif %}
		</div>
		<div class="tab-content active" id="config">
			<h3>{{ i18n.t('CONFIG_TITLE', lang) }}</h3>
			<form method="POST" action="{{ url_for('save_config_route', lang=lang) }}">
				<h4>{{ i18n.t('STANDARD_SETTINGS', lang) }}</h4>
				{% for field in fields if not field.key.startswith('ai_settings.') %}
					<div class="mb-3">
						<label for="{{ field.key }}" class="form-label">{{ field.label }}</label>
						<input type="text" class="form-control" id="{{ field.key }}" name="{{ field.key }}" value="{{ field.value }}">
						{% if field.use_env %}
							<div class="form-check mt-2">
								<input type="checkbox" class="form-check-input" id="{{ field.key }}_use_env" name="{{ field.key }}_use_env" {{ 'checked' if field.use_env else '' }}>
								<label class="form-check-label" for="{{ field.key }}_use_env">{{ i18n.t('USE_ENV', lang) }}</label>
								<small class="text-muted">{{ i18n.t('TOOLTIP_ENV', lang) }}</small>
							</div>
						{% endif %}
					</div>
				{% endfor %}
				<h4>{{ i18n.t('AI_SETTINGS', lang) }}</h4>
				{% for field in fields if field.key.startswith('ai_settings.') %}
					<div class="mb-3">
						<label for="{{ field.key }}" class="form-label">{{ field.label }}</label>
						<input type="text" class="form-control" id="{{ field.key }}" name="{{ field.key }}" value="{{ field.value }}">
						{% if field.use_env %}
							<div class="form-check mt-2">
								<input type="checkbox" class="form-check-input" id="{{ field.key }}_use_env" name="{{ field.key }}_use_env" {{ 'checked' if field.use_env else '' }}>
								<label class="form-check-label" for="{{ field.key }}_use_env">{{ i18n.t('USE_ENV', lang) }}</label>
								<small class="text-muted">{{ i18n.t('TOOLTIP_ENV', lang) }}</small>
							</div>
						{% endif %}
					</div>
				{% endfor %}
				<h4>AI Models</h4>
				<table class="table table-dark table-striped">
					<thead>
						<tr>
							<th>Name</th>
							<th>URL</th>
							<th>Access Token Env</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for name, model in config.models.items() %}
							<tr>
								<td>{{ model.name }}</td>
								<td>{{ model.url }}</td>
								<td>{{ model.access_token_env }}</td>
								<td>
									<form method="POST" action="{{ url_for('delete_model', lang=lang) }}" style="display:inline;">
										<input type="hidden" name="model_name" value="{{ model.name }}">
										<button type="submit" class="btn btn-danger btn-sm">Delete</button>
									</form>
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
				<h5>Add New Model</h5>
				<form method="POST" action="{{ url_for('add_model', lang=lang) }}">
					<div class="mb-3">
						<label for="model_name" class="form-label">Model Name</label>
						<input type="text" class="form-control" id="model_name" name="model_name" required>
					</div>
					<div class="mb-3">
						<label for="model_url" class="form-label">Model URL</label>
						<input type="text" class="form-control" id="model_url" name="model_url" required>
					</div>
					<div class="mb-3">
						<label for="access_token_env" class="form-label">Access Token Environment Variable</label>
						<input type="text" class="form-control" id="access_token_env" name="access_token_env" required>
					</div>
					<button type="submit" class="btn btn-primary">Add Model</button>
				</form>
				<button type="submit" class="btn btn-primary mt-3">{{ i18n.t('SAVE_CONFIG', lang) }}</button>
			</form>
		</div>
<!-- dashboard.html (update the users tab-content) -->
<div class="tab-content active" id="users">
	<h3>{{ i18n.t('USERS_TAB', lang) }}</h3>
	<table class="table table-dark">
		<thead>
			<tr>
				<th>{{ i18n.t('USER_ID', lang) }}</th>
				<th>{{ i18n.t('USERNAME', lang) }}</th>
				<th>{{ i18n.t('BADGES', lang) }}</th>
				<th>{{ i18n.t('CREDITS', lang) }}</th>
				<th>{{ i18n.t('PROMOTE_CREDITS', lang) }}</th>
				<th>{{ i18n.t('BLACKLIST', lang) }}</th>
			</tr>
		</thead>
		<tbody>
			{% for user in users %}
			<tr>
				<td>{{ user.user_id }}</td>
				<td>{{ user.username }}</td>
				<td>{{ user.badges | safe }}</td>
				<td>{{ user.credits }}</td>
				<td>
					<form action="{{ url_for('promote_credits', lang=lang) }}" method="POST" class="promote-credits-form">
						<input type="hidden" name="user_id" value="{{ user.user_id }}">
						<input type="number" name="credits" min="1" placeholder="{{ i18n.t('ENTER_CREDITS', lang) }}" required>
						<button type="submit" class="btn btn-primary">{{ i18n.t('SUBMIT', lang) }}</button>
					</form>
				</td>
				<td>
					<form action="{{ url_for('toggle_blacklist', lang=lang) }}" method="POST" class="toggle-blacklist-form">
						<input type="hidden" name="user_id" value="{{ user.user_id }}">
						<button type="submit" class="btn btn-{{ 'danger' if user.is_blacklisted else 'secondary' }}">
							{{ i18n.t('UNBLACKLIST' if user.is_blacklisted else 'BLACKLIST', lang) }}
						</button>
					</form>
				</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
</div>
		<div class="tab-content" id="github">
		{% if not github_info.url %}
			<div class="alert alert-warning">{{ i18n.t('CONFIGURE_GITHUB_URL', lang) }}</div>
		{% else %}
			<div class="time-range-selector">
				<label>{{ i18n.t('TIME_RANGE', lang) }}:
					<select id="time-range">
						<option value="1d">{{ i18n.t('TIME_RANGE_1D', lang) }}</option>
						<option value="7d">{{ i18n.t('TIME_RANGE_7D', lang) }}</option>
						<option value="30d" selected>{{ i18n.t('TIME_RANGE_30D', lang) }}</option>
						<option value="90d">{{ i18n.t('TIME_RANGE_90D', lang) }}</option>
						<option value="180d">{{ i18n.t('TIME_RANGE_180D', lang) }}</option>
						<option value="365d">{{ i18n.t('TIME_RANGE_365D', lang) }}</option>
						<option value="all">{{ i18n.t('TIME_RANGE_ALL', lang) }}</option>
					</select>
				</label>
			</div>
			<div class="per-page-selector">
				<label>{{ i18n.t('PER_PAGE', lang) }}:
					<select id="per-page">
						<option value="10">10</option>
						<option value="25" selected>25</option>
						<option value="50">50</option>
						<option value="100">100</option>
					</select>
				</label>
			</div>
			<div id="info-container"></div>
			<div id="loading">{{ i18n.t('LOADING', lang) }}</div>
			<div id="charts-container"></div>
			<div class="pagination" id="pagination"></div>
		{% endif %}
		</div>
		<a href="{{ url_for('logout', lang=lang) }}" class="btn btn-secondary mt-3">{{ i18n.t('LOGOUT', lang) }}</a>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
	<script>
		particlesJS('particles-js', {
			"particles": {
				"number": {"value": 80, "density": {"enable": true, "value_area": 800}},
				"color": {"value": "#ffffff"},
				"shape": {"type": "circle"},
				"opacity": {"value": 0.5, "random": true, "anim": {"enable": true, "speed": 1, "opacity_min": 0.1, "sync": false}},
				"size": {"value": 3, "random": true, "anim": {"enable": true, "speed": 2, "size_min": 0.1, "sync": false}},
				"line_linked": {"enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.4, "width": 1},
				"move": {"enable": true, "speed": 2, "direction": "none", "random": true, "straight": false, "out_mode": "out", "bounce": false, "attract": {"enable": true, "rotateX": 600, "rotateY": 1200}}
			},
			"interactivity": {
				"detect_on": "canvas",
				"events": {"onhover": {"enable": true, "mode": "grab"}, "onclick": {"enable": true, "mode": "push"}, "resize": true},
				"modes": {"grab": {"distance": 140, "line_linked": {"opacity": 1}}, "push": {"particles_nb": 4}}
			},
			"retina_detect": true
		});

		document.querySelectorAll('.tab').forEach(tab => {
			tab.addEventListener('click', () => {
				document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
				document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
				tab.classList.add('active');
				document.getElementById(tab.dataset.tab).classList.add('active');
			});
		});

		document.querySelectorAll('.promote-credits-form').forEach(form => {
			form.style.display = 'flex';
			form.style.gap = '10px';
			form.querySelector('input[type="number"]').style.width = '65%';
			form.querySelector('input[type="number"]').style.backgroundColor = '#2a2a2a';
			form.querySelector('input[type="number"]').style.color = '#fff';
			form.querySelector('input[type="number"]').style.border = '1px solid #48ff00';
			form.querySelector('button').style.width = '33%';
			form.querySelector('button').style.padding = '5px 10px';
		});

		document.querySelectorAll('.toggle-blacklist-form').forEach(form => {
			form.style.display = 'inline-block';
			form.querySelector('button').style.width = '33%'
			form.querySelector('button').style.padding = '5px 10px';
		});
{% if github_info.url %}
let allRepos = [];
let currentPage = 1;
let reposPerPage = 25;

// GitHub info from server
const githubInfo = {
    baseUrl: '{{ github_info.url }}',
    username: '{{ github_info.username }}',
    repo: '{{ github_info.repo }}'
};

function githubMarkdownToHtml(markdown) {
    const container = document.createElement('div');
    marked.setOptions({
        gfm: true,
        breaks: true,
        tables: true,
        pedantic: false,
        sanitize: false,
        smartLists: true,
        smartypants: false,
        highlight: function(code, lang) {
            if (typeof hljs !== 'undefined' && lang) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (e) {
                    console.warn(`Error highlighting ${lang} code:`, e);
                }
            }
            return code;
        }
    });
    container.innerHTML = marked.parse(markdown);
    postProcessHtml(container);
    return container.innerHTML;
}

function postProcessHtml(container) {
    container.querySelectorAll('pre').forEach(pre => {
        pre.classList.add('github-markdown-pre');
        const code = pre.querySelector('code');
        if (code) code.classList.add('github-markdown-code');
    });
    container.querySelectorAll('table').forEach(table => {
        table.classList.add('github-markdown-table');
    });
    container.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(header => {
        const id = header.textContent.toLowerCase().replace(/[^\w\u4e00-\u9fa5]+/g, '-').replace(/^-+|-+$/g, '');
        header.id = id;
        const anchor = document.createElement('a');
        anchor.className = 'github-markdown-header-anchor';
        anchor.href = `#${id}`;
        anchor.innerHTML = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>';
        header.prepend(anchor);
    });
}

function ToggleReadMe(repoName, fullName) {
    const readmeContainer = document.getElementById(`readme-${repoName}`);
    if (readmeContainer.style.display === 'none') {
        readmeContainer.style.display = 'block';
    } else {
        readmeContainer.style.display = 'none';
    }
}

async function fetchAndDisplayReadme(repoName, fullName) {
    const readmeContainer = document.getElementById(`readme-${repoName}`);
    try {
        const response = await fetch(`https://raw.githubusercontent.com/${fullName}/main/README.md`);
        if (!response.ok) {
            throw new Error(`Failed to fetch README: ${response.status}`);
        }
        let markdown = await response.text();
        markdown = convertRelativeUrls(markdown, fullName);
        const html = githubMarkdownToHtml(markdown);
        const modalHTML = `
            <div class="readme-modal-overlay" onclick="ToggleReadMe('${repoName}')">
                <div class="readme-modal-content" onclick="event.stopPropagation()">
                    <div class="readme-modal-body">${html}</div>
                </div>
            </div>
        `;
        readmeContainer.innerHTML = modalHTML;
        readmeContainer.style.display = 'none';
        processImagesAndLinks(readmeContainer, fullName);
        if (typeof hljs !== 'undefined') {
            document.querySelectorAll('.readme-modal-body pre code').forEach(block => {
                hljs.highlightElement(block);
            });
        }
    } catch (error) {
        readmeContainer.innerHTML = `
            <div class="readme-modal-overlay" onclick="ToggleReadMe('${repoName}')">
                <div class="readme-modal-content" onclick="event.stopPropagation()">
                    <div class="readme-modal-body">
                        <p>{{ i18n.t('README_ERROR', lang) }} ${repoName}</p>
                        <p>${error.message}</p>
                    </div>
                </div>
            </div>
        `;
        readmeContainer.style.display = 'none';
    }
}

function convertRelativeUrls(markdown, fullName) {
    markdown = markdown.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, altText, path) => {
        if (!path.startsWith('http') && !path.startsWith('data:')) {
            if (path.startsWith('/')) {
                path = `https://raw.githubusercontent.com/${fullName}/main${path}`;
            } else {
                path = `https://raw.githubusercontent.com/${fullName}/main/${path}`;
            }
        }
        return `![${altText}](${path})`;
    });
    markdown = markdown.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, path) => {
        if (!path.startsWith('http') && !path.startsWith('#') && !path.startsWith('mailto:')) {
            if (path.startsWith('/')) {
                path = `https://github.com/${fullName}/blob/main${path}`;
            } else {
                path = `https://github.com/${fullName}/blob/main/${path}`;
            }
        }
        return `[${text}](${path})`;
    });
    return markdown;
}

function processImagesAndLinks(container, fullName) {
    container.querySelectorAll('img').forEach(img => {
        const src = img.getAttribute('src');
        if (src && !src.startsWith('http') && !src.startsWith('data:')) {
            const absoluteSrc = src.startsWith('/')
                ? `https://raw.githubusercontent.com/${fullName}/main${src}`
                : `https://raw.githubusercontent.com/${fullName}/main/${src}`;
            img.setAttribute('src', absoluteSrc);
        }
    });
    container.querySelectorAll('a').forEach(a => {
        const href = a.getAttribute('href');
        if (href && !href.startsWith('http') && !href.startsWith('#') && !href.startsWith('mailto:')) {
            const absoluteHref = href.startsWith('/')
                ? `https://github.com/${fullName}/blob/main${href}`
                : `https://github.com/${fullName}/blob/main/${href}`;
            a.setAttribute('href', absoluteHref);
            a.setAttribute('target', '_blank');
        }
    });
}

function getBasePath() {
    return githubInfo.baseUrl.endsWith('/') ? githubInfo.baseUrl : githubInfo.baseUrl + '/';
}

async function fetchTrafficData(repoName) {
    try {
        const basePath = getBasePath();
        const [viewsRes, clonesRes] = await Promise.all([
            fetch(`${basePath}data/repos/${encodeURIComponent(repoName)}/views.json`),
            fetch(`${basePath}data/repos/${encodeURIComponent(repoName)}/clones.json`)
        ]);
        if (!viewsRes.ok) {
            console.warn(`Views data not found for ${repoName}`);
            return { views: { views: [] } };
        }
        if (!clonesRes.ok) {
            console.warn(`Clones data not found for ${repoName}`);
            return { clones: { clones: [] } };
        }
        const views = await viewsRes.json();
        const clones = await clonesRes.json();
        const trafficData = { views: views || { views: [] }, clones: clones || { clones: [] } };
        if (!validateTrafficData(trafficData)) {
            throw new Error('Invalid data structure');
        }
        return trafficData;
    } catch (error) {
        console.error(`Error loading traffic data for ${repoName}:`, error);
        return { views: { views: [] }, clones: { clones: [] } };
    }
}

async function fetchAllRepos() {
    try {
        const basePath = getBasePath();
        const response = await fetch(`${basePath}data/repo-info.json`);
        let data;
        if (!response.ok) {
            // Fallback to GitHub raw URL
            const fallbackUrl = `https://raw.githubusercontent.com/${githubInfo.username}/${githubInfo.repo}/main/data/repo-info.json`;
            const fallbackResponse = await fetch(fallbackUrl);
            if (!fallbackResponse.ok) {
                throw new Error('Repository list not found');
            }
            data = await fallbackResponse.json();
        } else {
            data = await response.json();
        }
        return Array.isArray(data) ? { repositories: data } : data;
    } catch (error) {
        console.error('Error loading repositories:', error);
        showInfoBox();
        return { repositories: [] };
    }
}

function validateTrafficData(data) {
    if (!data) return false;
    if (data.views && !Array.isArray(data.views.views)) return false;
    if (data.clones && !Array.isArray(data.clones.clones)) return false;
    return true;
}

function formatDate(isoString) {
    const date = new Date(isoString);
    return date.toLocaleDateString('{{ lang }}', { year: 'numeric', month: 'short', day: 'numeric' });
}

function fillMissingDates(data, range) {
    if (data.length === 0) return data;
    const dateMap = new Map();
    data.forEach(item => dateMap.set(item.timestamp.split('T')[0], item));
    const sortedDates = [...dateMap.keys()].sort();
    const startDate = new Date(sortedDates[0]);
    const endDate = new Date(sortedDates[sortedDates.length - 1]);
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        if (!dateMap.has(dateStr)) {
            dateMap.set(dateStr, { timestamp: dateStr, count: 0, uniques: 0 });
        }
    }
    return [...dateMap.values()].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
}

function createChart(canvasId, label, data, labels, total) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (data.length === 0) {
        ctx.parentElement.innerHTML = `<p>{{ i18n.t('NO_DATA', lang) }}</p>`;
        return;
    }
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: `${label} ({{ i18n.t('TOTAL', lang) }}: ${total || 0})`,
                data: data,
                borderColor: '#48ff00',
                backgroundColor: 'rgba(72, 255, 0, 0.2)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top', labels: { color: '#fff' } }
            },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255, 255, 255, 0.2)' } },
                x: { ticks: { color: '#fff', maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
            }
        }
    });
}

function showError(message) {
    const container = document.getElementById('charts-container');
    container.innerHTML = `<div class="error">${message}</div>`;
}

function showInfoBox() {
    document.getElementById('info-container').innerHTML = `<div class="info-box">{{ i18n.t('INFO_BOX', lang) }}</div>`;
}

function setupPagination(totalRepos, reposPerPage) {
    const totalPages = Math.ceil(totalRepos / reposPerPage);
    const paginationDiv = document.getElementById('pagination');
    paginationDiv.innerHTML = '';
    if (totalPages <= 1) return;

    const prevButton = document.createElement('button');
    prevButton.innerHTML = '{{ i18n.t('PREVIOUS_PAGE', lang) }}';
    prevButton.disabled = currentPage === 1;
    prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage -= 1;
            displayRepos();
        }
    });
    paginationDiv.appendChild(prevButton);

    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        if (i === currentPage) pageButton.classList.add('active');
        pageButton.addEventListener('click', () => {
            currentPage = i;
            displayRepos();
        });
        paginationDiv.appendChild(pageButton);
    }

    const nextButton = document.createElement('button');
    nextButton.innerHTML = '{{ i18n.t('NEXT_PAGE', lang) }}';
    nextButton.disabled = currentPage === totalPages;
    nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage += 1;
            displayRepos();
        }
    });
    paginationDiv.appendChild(nextButton);
    paginationDiv.style.display = 'flex';
}

function filterDataByDateRange(data, range) {
    if (range === 'all') return data;
    const days = parseInt(range) || 30;
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);
    return data.filter(item => new Date(item.timestamp) >= cutoffDate);
}

async function displayRepos() {
    if (!allRepos || !allRepos.repositories) {
        showError('{{ i18n.t('ERROR_LOADING_REPOS', lang) }}');
        return;
    }
    const selectedRange = document.getElementById('time-range').value;
    const startIdx = (currentPage - 1) * reposPerPage;
    const endIdx = startIdx + reposPerPage;
    const reposToShow = allRepos.repositories.slice(startIdx, endIdx);
    const totalPages = Math.ceil(allRepos.repositories.length / reposPerPage);

    document.getElementById('charts-container').innerHTML = '';
    document.getElementById('loading').textContent = '{{ i18n.t('LOADING_REPOS', lang) }}'.replace('(0)', `(${reposToShow.length})`);

    document.querySelector('.per-page-selector').style.display = 'block';
    document.querySelector('.time-range-selector').style.display = 'block';
    document.querySelector('.info-box').style.display = 'none';

    let loadedCount = 0;
    for (const repo of reposToShow) {
        document.getElementById('loading').textContent = '{{ i18n.t('LOADING_REPOS', lang) }}'.replace('%d', ++loadedCount);
        const trafficData = await fetchTrafficData(repo.name);
        const filteredViews = filterDataByDateRange(trafficData.views.views, selectedRange);
        const filteredClones = filterDataByDateRange(trafficData.clones.clones, selectedRange);
        const completeViews = fillMissingDates(filteredViews, selectedRange);
        const completeClones = fillMissingDates(filteredClones, selectedRange);

        const container = document.createElement('div');
        container.className = 'chart-box';
        const escapedRepoName = repo.name.replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>').replace(/"/g, '"').replace(/'/g, '');
        container.innerHTML = `
            <h3>
                <a href="https://github.com/${repo.full_name}" target="_blank">🔗 {{ i18n.t('REPO_HEADER', lang) }}.</a> |
                <a href="https://github.com/${repo.full_name}/zipball/main" target="_top">zip⬇</a> |
                <a href="https://github.com/${repo.full_name}/tarball/main" target="_top">tar⬇</a> |
                <a href="https://github.com/${repo.full_name}/fork" target="_blank">fork🖈</a> |
                <a onclick="ToggleReadMe('${escapedRepoName}', '${repo.full_name}')" id="toggle-${escapedRepoName}">README.md+</a>
            </h3>
            <div id="readme-${escapedRepoName}" style="display:none;"></div>
            <div class="stats-summary">
                <div class="stat-item">
                    <span class="stat-label">{{ i18n.t('VIEWS', lang) }}:</span>
                    <span class="stat-value">${trafficData.views.count || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">{{ i18n.t('CLONES', lang) }}:</span>
                    <span class="stat-value">${trafficData.clones.count || 0}</span>
                </div>
            </div>
            <div class="chart-row">
                <div class="chart-container">
                    <canvas id="views-${escapedRepoName}"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="clones-${escapedRepoName}"></canvas>
                </div>
            </div>
        `.replace('%s', escapedRepoName);
        document.getElementById('charts-container').appendChild(container);
        fetchAndDisplayReadme(repo.name, repo.full_name);
        createChart(`views-${escapedRepoName}`, '{{ i18n.t('VIEWS', lang) }}', completeViews.map(v => v.count), completeViews.map(v => formatDate(v.timestamp)), trafficData.views.count);
        createChart(`clones-${escapedRepoName}`, '{{ i18n.t('CLONES', lang) }}', completeClones.map(c => c.count), completeClones.map(c => formatDate(c.timestamp)), trafficData.clones.count);
    }

    document.getElementById('pagination').style.display = 'flex';
    document.getElementById('loading').textContent = '{{ i18n.t('PAGE_STATS', lang) }}'
        .replace('%d', currentPage)
        .replace('%d', totalPages)
        .replace('%d', allRepos.repositories.length);
    setupPagination(allRepos.repositories.length, reposPerPage);
}

async function main() {
    showInfoBox();
    allRepos = await fetchAllRepos();
    if (!allRepos.repositories || allRepos.repositories.length === 0) {
        showInfoBox();
        return;
    }
    displayRepos();
    {% if command_usage %}
    		const commandUsage = {{ command_usage | tojson }};
		if (commandUsage && commandUsage.length > 0) {
			const ctx = document.createElement('canvas');
			ctx.id = 'command-usage-chart';
			ctx.style.width = '100%';
			ctx.style.height = '400px';
			document.querySelector('.status-container').insertBefore(ctx, document.querySelector('.table'));

			const labels = commandUsage.map(usage => `/${usage.command}`);
			const percentages = commandUsage.map(usage => usage.percentage);

			new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: '{{ i18n.t('COMMAND_USAGE_PERCENTAGE', lang) }}',
						data: percentages,
						backgroundColor: 'rgba(72, 255, 0, 0.6)',
						borderColor: '#48ff00',
						borderWidth: 1
					}]
				},
				options: {
					responsive: true,
					plugins: {
						legend: { display: true, position: 'top', labels: { color: '#fff' } },
						title: { display: true, text: '{{ i18n.t('COMMAND_USAGE_CHART', lang) }}', color: '#fff' }
					},
					scales: {
						y: {
							beginAtZero: true,
							max: 100,
							ticks: { color: '#fff', callback: value => value + '%' },
							grid: { color: 'rgba(255, 255, 255, 0.2)' }
						},
						x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
					}
				}
			});
		}
    {% else %}
    {% endif %}
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('per-page').addEventListener('change', (e) => {
        reposPerPage = parseInt(e.target.value) || 25;
        currentPage = 1;
        displayRepos();
    });
    document.getElementById('time-range').addEventListener('change', displayRepos);
    main();
});
{% endif %}
	</script>
</body>
</html>