<!DOCTYPE html>
<html lang="{{ lang }}" {{ 'dir="rtl"' if lang in ['ar', 'he'] else '' }}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ i18n.t('DASHBOARD_TITLE', lang) }}</title>
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@codemirror/theme-dracula@0.21.0/dist/index.min.css">
</head>
<body>
    <div class="particles" id="particles-js"></div>
    <div class="language-switcher">
        <select onchange="window.location.href='/' + this.value">
            {% for code in ['en', 'tr', 'ar', 'he', 'la'] %}
                <option value="{{ code }}" {{ 'selected' if code == lang else '' }}>{{ i18n.t('LANGUAGE_NAME_' + code.upper(), lang) }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="logo-container">
        <div class="logo">NumberFansBot</div>
        <div class="tagline">{{ i18n.t('TAGLINE', lang) }}</div>
    </div>
    <div class="status-container">
        <h2>{{ i18n.t('DASHBOARD_TITLE', lang) }}</h2>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert {{ 'alert-success' if category == 'success' else 'alert-danger' }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <div class="tabs">
            {% if command_usage %}
                <div class="tab active" data-tab="commands">{{ i18n.t('COMMANDS_TAB', lang) }}</div>
            {% endif %}
            <div class="tab{% if not command_usage %} active{% endif %}" data-tab="config">{{ i18n.t('CONFIG_TAB', lang) }}</div>
            <div class="tab" data-tab="users">{{ i18n.t('USERS_TAB', lang) }}</div>
            {% if github_info.url %}
                <div class="tab" data-tab="github">{{ i18n.t('GITHUB_TRAFFIC_TAB', lang) }}</div>
            {% endif %}
            <div class="tab" data-tab="files">{{ i18n.t('FILES_TAB', lang) }}</div>
            <div class="link-tab" data-tab="install">
                <a href="{{ url_for('install', lang=lang) }}" class="btn btn-primary">{{ i18n.t('INSTALL_TAB', lang) }}</a>
            </div>
        </div>
        <div class="tab-content{% if command_usage %} active{% endif %}" id="commands">
            <h2>{{ i18n.t('COMMANDS_TITLE', lang) }}</h2>
            <p>{{ i18n.t('COMMANDS_DESCRIPTION', lang) }}</p>
            {% if command_usage %}
                <table class="table table-dark table-striped" id="commands-table">
                    <thead>
                        <tr>
                            <th>{{ i18n.t('COMMAND_NAME', lang) }}</th>
                            <th>{{ i18n.t('USAGE_COUNT', lang) }}</th>
                            <th>{{ i18n.t('LAST_USED', lang) }}</th>
                            <th>{{ i18n.t('LAST_USER', lang) }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for usage in command_usage %}
                            <tr>
                                <td>/{{ usage['command'] }}</td>
                                <td>{{ usage['count'] }}</td>
                                <td>{{ usage['last_used'].strftime('%Y-%m-%d %H:%M:%S') if usage.get('last_used') else 'N/A' }}</td>
                                <td>{{ usage['last_user_id'] if usage.get('last_user_id') else 'N/A' }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>
        <div class="tab-content{% if not command_usage %} active{% endif %}" id="config">
            <h3>{{ i18n.t('CONFIG_TITLE', lang) }}</h3>
            <form method="POST" action="{{ url_for('save_config_route', lang=lang) }}">
                <h4>{{ i18n.t('STANDARD_SETTINGS', lang) }}</h4>
                {% for field in fields if not field.key.startswith('ai_settings.') %}
                    <div class="mb-3">
                        <label for="{{ field.key }}" class="form-label">{{ field.label }}</label>
                        <input type="text" class="form-control" id="{{ field.key }}" name="{{ field.key }}" value="{{ field.value }}">
                        {% if field.use_env %}
                            <div class="form-check mt-2">
                                <input type="checkbox" class="form-check-input" id="{{ field.key }}_use_env" name="{{ field.key }}_use_env" {{ 'checked' if field.use_env else '' }}>
                                <label class="form-check-label" for="{{ field.key }}_use_env">{{ i18n.t('USE_ENV', lang) }}</label>
                                <small class="text-muted">{{ i18n.t('TOOLTIP_ENV', lang) }}</small>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
                <h4>{{ i18n.t('AI_SETTINGS', lang) }}</h4>
                {% for field in fields if field.key.startswith('ai_settings.') %}
                    <div class="mb-3">
                        <label for="{{ field.key }}" class="form-label">{{ field.label }}</label>
                        <input type="text" class="form-control" id="{{ field.key }}" name="{{ field.key }}" value="{{ field.value }}">
                        {% if field.use_env %}
                            <div class="form-check mt-2">
                                <input type="checkbox" class="form-check-input" id="{{ field.key }}_use_env" name="{{ field.key }}_use_env" {{ 'checked' if field.use_env else '' }}>
                                <label class="form-check-label" for="{{ field.key }}_use_env">{{ i18n.t('USE_ENV', lang) }}</label>
                                <small class="text-muted">{{ i18n.t('TOOLTIP_ENV', lang) }}</small>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
                <h4>AI Models</h4>
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>URL</th>
                            <th>Access Token Env</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for name, model in config.models.items() %}
                            <tr>
                                <td>{{ model.name }}</td>
                                <td>{{ model.url }}</td>
                                <td>{{ model.access_token_env }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('delete_model', lang=lang) }}" style="display:inline;">
                                        <input type="hidden" name="model_name" value="{{ model.name }}">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <h5>Add New Model</h5>
                <form method="POST" action="{{ url_for('add_model', lang=lang) }}">
                    <div class="mb-3">
                        <label for="model_name" class="form-label">Model Name</label>
                        <input type="text" class="form-control" id="model_name" name="model_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="model_url" class="form-label">Model URL</label>
                        <input type="text" class="form-control" id="model_url" name="model_url" required>
                    </div>
                    <div class="mb-3">
                        <label for="access_token_env" class="form-label">Access Token Environment Variable</label>
                        <input type="text" class="form-control" id="access_token_env" name="access_token_env" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Model</button>
                </form>
                <button type="submit" class="btn btn-primary mt-3">{{ i18n.t('SAVE_CONFIG', lang) }}</button>
            </form>
        </div>
        <style>
            #users table {
                thead tr th, tbody tr td {
                    max-width: calc(100% / 7);
                    min-width: calc(100% / 8);
                }
            }
        </style>
        <div class="tab-content" id="users">
            <h3>{{ i18n.t('USERS_TAB', lang) }}</h3>
            <table class="table table-dark">
                <thead>
                    <tr>
                        <th style="text-align: left;">{{ i18n.t('USER_ID', lang) }}</th>
                        <th style="text-align: left;">{{ i18n.t('USERNAME', lang) }}</th>
                        <th style="text-align: center;">{{ i18n.t('BADGES', lang) }}</th>
                        <th style="text-align: center;">{{ i18n.t('CREDITS', lang) }}</th>
                        <th style="text-align: right;">{{ i18n.t('PROMOTE_CREDITS', lang) }}</th>
                        <th style="text-align: right;">{{ i18n.t('BLACKLIST', lang) }}</th>
                        <th style="text-align: right;">{{ i18n.t('BETA_TESTER', lang) }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr>
                            <td style="text-align: left;">{{ user.user_id }}</td>
                            <td style="text-align: left;">{{ user.username }}</td>
                            <td style="text-align: center;">{{ user.badges | safe }}</td>
                            <td style="text-align: center;">{{ user.credits }}</td>
                            <td style="text-align: right;">
                                <form action="{{ url_for('promote_credits', lang=lang) }}" method="POST" class="promote-credits-form">
                                    <input type="hidden" name="user_id" value="{{ user.user_id }}">
                                    <input type="number" name="credits" min="1" placeholder="{{ i18n.t('ENTER_CREDITS', lang) }}" required>
                                    <button type="submit" class="btn btn-primary">{{ i18n.t('SUBMIT', lang) }}</button>
                                </form>
                            </td>
                            <td style="text-align: right;">
                                <form action="{{ url_for('toggle_blacklist', lang=lang) }}" method="POST" class="toggle-blacklist-form">
                                    <input type="hidden" name="user_id" value="{{ user.user_id }}">
                                    <button type="submit" class="btn btn-{{ 'danger' if user.is_blacklisted else 'secondary' }}">
                                        {{ i18n.t('UNBLACKLIST' if user.is_blacklisted else 'BLACKLIST', lang) }}
                                    </button>
                                </form>
                            </td>
                            <td style="text-align: right;">
                                <form action="{{ url_for('toggle_beta_tester', lang=lang) }}" method="POST" class="toggle-beta-tester-form">
                                    <input type="hidden" name="user_id" value="{{ user.user_id }}">
                                    <button type="submit" class="btn btn-{{ 'secondary' if user.is_beta_tester else 'danger' }}">
                                        {{ i18n.t('REVOKE_ACCESS' if user.is_beta_tester else 'GRANT_ACCESS', lang) }}
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="tab-content" id="github">
            {% if not github_info.url %}
                <div class="alert alert-warning">{{ i18n.t('CONFIGURE_GITHUB_URL', lang) }}</div>
            {% else %}
                <div class="time-range-selector">
                    <label>{{ i18n.t('TIME_RANGE', lang) }}:
                        <select id="time-range">
                            <option value="1d">{{ i18n.t('TIME_RANGE_1D', lang) }}</option>
                            <option value="7d">{{ i18n.t('TIME_RANGE_7D', lang) }}</option>
                            <option value="30d" selected>{{ i18n.t('TIME_RANGE_30D', lang) }}</option>
                            <option value="90d">{{ i18n.t('TIME_RANGE_90D', lang) }}</option>
                            <option value="180d">{{ i18n.t('TIME_RANGE_180D', lang) }}</option>
                            <option value="365d">{{ i18n.t('TIME_RANGE_365D', lang) }}</option>
                            <option value="all">{{ i18n.t('TIME_RANGE_ALL', lang) }}</option>
                        </select>
                    </label>
                </div>
                <div class="per-page-selector">
                    <label>{{ i18n.t('PER_PAGE', lang) }}:
                        <select id="per-page">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </label>
                </div>
                <div id="info-container"></div>
                <div id="loading">{{ i18n.t('LOADING', lang) }}</div>
                <div id="charts-container"></div>
                <div class="pagination" id="pagination"></div>
            {% endif %}
        </div>
        <div class="tab-content" id="files">
            <h3>{{ i18n.t('FILES_TAB', lang) }}</h3>
            <div class="create-file-form">
                <form id="create-file-form">
                    <div class="mb-3">
                        <label for="new-file-path" class="form-label">{{ i18n.t('FILE_PATH', lang) }}</label>
                        <input type="text" class="form-control" id="new-file-path" placeholder="e.g., Bot/new_script.py" required>
                    </div>
                    <button type="submit" class="btn btn-primary">{{ i18n.t('CREATE', lang) }}</button>
                </form>
            </div>
            <div class="files-tab-content">
                <div class="file-tree-container">
                    <div class="file-tree" id="file-tree"></div>
                </div>
                <div class="editor-container" id="editor-container">
                    <h4 id="editor-title"></h4>
                    <textarea id="editor"></textarea>
                    <div class="file-actions">
                        <button class="btn btn-primary" id="save-file">{{ i18n.t('SAVE', lang) }}</button>
                        <button class="btn btn-danger" id="delete-file">{{ i18n.t('DELETE', lang) }}</button>
                    </div>
                </div>
            </div>
        </div>
        <a href="{{ url_for('logout', lang=lang) }}" class="btn btn-secondary mt-3">{{ i18n.t('LOGOUT', lang) }}</a>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@codemirror/lang-python@6.1.3/dist/index.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@codemirror/lang-html@6.4.5/dist/index.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@codemirror/lang-javascript@6.2.1/dist/index.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@codemirror/lang-css@6.2.1/dist/index.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@codemirror/lang-yaml@6.0.0/dist/index.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@codemirror/lang-sql@6.5.2/dist/index.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/codemirror@6.0.1/dist/index.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@codemirror/theme-dracula@0.21.0/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <script src="{{ url_for('static', filename='dashboard.js') }}"></script>
</body>
</html>