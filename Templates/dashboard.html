<!DOCTYPE html>
<html lang="{{ lang }}" {{ 'dir="rtl"' if lang in ['ar', 'he'] else '' }}>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ i18n.t('DASHBOARD_TITLE', lang) }}</title>
	<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
	<link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
	<link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
	<link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/lib/codemirror.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/theme/dracula.min.css">
</head>
<body>
	<div class="particles" id="particles-js"></div>
	<div class="language-switcher">
		<select onchange="window.location.href='/' + this.value">
			{% for code in ['en', 'tr', 'ar', 'he', 'la'] %}
				<option value="{{ code }}" {{ 'selected' if code == lang else '' }}>{{ i18n.t('LANGUAGE_NAME_' + code.upper(), lang) }}</option>
			{% endfor %}
		</select>
	</div>
	<div class="logo-container">
		<div class="logo">NumberFansBot</div>
		<div class="tagline">{{ i18n.t('TAGLINE', lang) }}</div>
	</div>
	<div class="status-container tab-content">
		<h2>{{ i18n.t('DASHBOARD_TITLE', lang) }}</h2>
		{% with messages = get_flashed_messages(with_categories=true) %}
			{% if messages %}
				{% for category, message in messages %}
					<div class="alert {{ 'alert-success' if category == 'success' else 'alert-danger' }}">{{ message }}</div>
				{% endfor %}
			{% endif %}
		{% endwith %}
		<ul class="nav nav-tabs mb-4">
		{% if command_usage %}
			<li class="nav-item">
				<a class="nav-link" data-bs-toggle="tab" href="#commands" data-tab="commands">{{ i18n.t('COMMANDS_TAB', lang) }}</a>
			</li>
		{% endif %}
			<li class="nav-item">
				<a class="nav-link" data-bs-toggle="tab" href="#config" data-tab="config">{{ i18n.t('CONFIG_TAB', lang) }}</a>
			</li>
			<li class="nav-item">
				<a class="nav-link active" data-bs-toggle="tab" href="#users" data-tab="users">{{ i18n.t('USERS_TAB', lang) }}</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" data-bs-toggle="tab" href="#groups" data-tab="groups">{{ i18n.t('GROUPS_TAB', lang) }}</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" data-bs-toggle="tab" href="#products" data-tab="products">{{ i18n.t('PRODUCTS_TAB', lang) }}</a>
			</li>
		{% if github_info.url %}
			<li class="nav-item">
				<a class="nav-link" data-bs-toggle="tab" href="#github-traffic" data-tab="github-traffic">{{ i18n.t('GITHUB_TRAFFIC_TAB', lang) }}</a>
			</li>
		{% endif %}
			<li class="nav-item">
				<a class="nav-link" data-bs-toggle="tab" href="#files" data-tab="files">{{ i18n.t('FILES_TAB', lang) }}</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" data-bs-toggle="tab" href="#install" data-tab="install">{{ i18n.t('INSTALL_TAB', lang) }}</a>
			</li>
		</ul>
		<div class="tab-pane fade" id="commands">
			<h2>{{ i18n.t('COMMANDS_TITLE', lang) }}</h2>
			<p>{{ i18n.t('COMMANDS_DESCRIPTION', lang) }}</p>
			{% if command_usage %}
				<table class="table table-dark table-striped" id="commands-table">
					<thead>
						<tr>
							<th>{{ i18n.t('COMMAND_NAME', lang) }}</th>
							<th>{{ i18n.t('USAGE_COUNT', lang) }}</th>
							<th>{{ i18n.t('LAST_USED', lang) }}</th>
							<th>{{ i18n.t('LAST_USER', lang) }}</th>
						</tr>
					</thead>
					<tbody>
						{% for usage in command_usage %}
							<tr>
								<td>/{{ usage['command'] }}</td>
								<td>{{ usage['count'] }}</td>
								<td>{{ usage['last_used'].strftime('%Y-%m-%d %H:%M:%S') if usage.get('last_used') else 'N/A' }}</td>
								<td>{{ usage['last_user_id'] if usage.get('last_user_id') else 'N/A' }} {% for user in users %}{{ user.username if usage['last_user_id'] == user.user_id else ''}}{% endfor %} {% if usage.chat_id %}{% for group in groups %}{% if group.group_id == usage.chat_id %}({{ group.group_name }}){% endif %}{% endfor %}{% endif %}</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			{% endif %}
		</div>
		<div class="tab-pane fade" id="config">
			<h3>{{ i18n.t('CONFIG_TITLE', lang) }}</h3>
			<form method="POST" action="{{ url_for('save_config_route', lang=lang) }}">
				<h4>{{ i18n.t('STANDARD_SETTINGS', lang) }}</h4>
				{% for field in fields if not field.key.startswith('ai_settings.') %}
					<div class="mb-3">
						<label for="{{ field.key }}" class="form-label">{{ field.label }}</label>
						<input type="text" class="form-control" id="{{ field.key }}" name="{{ field.key }}" value="{{ field.value }}">
						{% if field.use_env %}
							<div class="form-check mt-2">
								<input type="checkbox" class="form-check-input" id="{{ field.key }}_use_env" name="{{ field.key }}_use_env" {{ 'checked' if field.use_env else '' }}>
								<label class="form-check-label" for="{{ field.key }}_use_env">{{ i18n.t('USE_ENV', lang) }}</label>
								<small class="text-muted">{{ i18n.t('TOOLTIP_ENV', lang) }}</small>
							</div>
						{% endif %}
					</div>
				{% endfor %}
				<h4>{{ i18n.t('AI_SETTINGS', lang) }}</h4>
				{% for field in fields if field.key.startswith('ai_settings.') %}
					<div class="mb-3">
						<label for="{{ field.key }}" class="form-label">{{ field.label }}</label>
						<input type="text" class="form-control" id="{{ field.key }}" name="{{ field.key }}" value="{{ field.value }}">
						{% if field.use_env %}
							<div class="form-check mt-2">
								<input type="checkbox" class="form-check-input" id="{{ field.key }}_use_env" name="{{ field.key }}_use_env" {{ 'checked' if field.use_env else '' }}>
								<label class="form-check-label" for="{{ field.key }}_use_env">{{ i18n.t('USE_ENV', lang) }}</label>
								<small class="text-muted">{{ i18n.t('TOOLTIP_ENV', lang) }}</small>
							</div>
						{% endif %}
					</div>
				{% endfor %}
				<h4>AI Models</h4>
				<table class="table table-dark table-striped">
					<thead>
						<tr>
							<th>Name</th>
							<th>URL</th>
							<th>Access Token Env</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for name, model in config.models.items() %}
							<tr>
								<td>{{ model.name }}</td>
								<td>{{ model.url }}</td>
								<td>{{ model.access_token_env }}</td>
								<td>
									<form method="POST" action="{{ url_for('delete_model', lang=lang) }}" style="display:inline;">
										<input type="hidden" name="model_name" value="{{ model.name }}">
										<button type="submit" class="btn btn-danger btn-sm">Delete</button>
									</form>
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
				<h5>Add New Model</h5>
				<form method="POST" action="{{ url_for('add_model', lang=lang) }}">
					<div class="mb-3">
						<label for="model_name" class="form-label">Model Name</label>
						<input type="text" class="form-control" id="model_name" name="model_name" required>
					</div>
					<div class="mb-3">
						<label for="model_url" class="form-label">Model URL</label>
						<input type="text" class="form-control" id="model_url" name="model_url" required>
					</div>
					<div class="mb-3">
						<label for="access_token_env" class="form-label">Access Token Environment Variable</label>
						<input type="text" class="form-control" id="access_token_env" name="access_token_env" required>
					</div>
					<button type="submit" class="btn btn-primary">Add Model</button>
				</form>
				<button type="submit" class="btn btn-primary mt-3">{{ i18n.t('SAVE_CONFIG', lang) }}</button>
			</form>
		</div>
		<style>
			#users table {
				thead tr th, tbody tr td {
					max-width: calc(100% / 7);
					min-width: calc(100% / 8);
				}
			}
		</style>
		<!-- Users Tab -->
		<div id="users" class="tab-pane fade show active">
			{% include 'users_partial.html' %}
		</div>
		<!-- Groups Tab -->
		<div id="groups" class="tab-pane fade">
			{% include 'groups_partial.html' %}
		</div>
		<!-- Products Tab -->
		<div id="products" class="tab-pane fade">
			{% include 'products_partial.html' %}
		</div>
		<!-- Github Repo Traffic Viewer Tab (fork metatronslove github-traffic-repo-viewer repository) -->
		<div class="tab-pane fade" id="github-traffic">
			{% if not github_info.url %}
				<div class="alert alert-warning">{{ i18n.t('CONFIGURE_GITHUB_URL', lang) }}</div>
			{% else %}
				<div class="time-range-selector">
					<label>{{ i18n.t('TIME_RANGE', lang) }}:
						<select id="time-range">
							<option value="1d">{{ i18n.t('TIME_RANGE_1D', lang) }}</option>
							<option value="7d">{{ i18n.t('TIME_RANGE_7D', lang) }}</option>
							<option value="30d" selected>{{ i18n.t('TIME_RANGE_30D', lang) }}</option>
							<option value="90d">{{ i18n.t('TIME_RANGE_90D', lang) }}</option>
							<option value="180d">{{ i18n.t('TIME_RANGE_180D', lang) }}</option>
							<option value="365d">{{ i18n.t('TIME_RANGE_365D', lang) }}</option>
							<option value="all">{{ i18n.t('TIME_RANGE_ALL', lang) }}</option>
						</select>
					</label>
				</div>
				<div class="per-page-selector">
					<label>{{ i18n.t('PER_PAGE', lang) }}:
						<select id="per-page">
							<option value="10">10</option>
							<option value="25" selected>25</option>
							<option value="50">50</option>
							<option value="100">100</option>
						</select>
					</label>
				</div>
				<div id="info-container"></div>
				<div id="loading">{{ i18n.t('LOADING', lang) }}</div>
				<div id="charts-container"></div>
				<div class="pagination" id="pagination"></div>
			{% endif %}
		</div>
		<div class="tab-pane fade" id="files">
			<h3>{{ i18n.t('FILES_TAB', lang) }}</h3>
			<div class="create-file-form">
				<form id="create-file-form">
					<div class="mb-3">
						<label for="new-file-path" class="form-label">{{ i18n.t('FILE_PATH', lang) }}</label>
						<input type="text" class="form-control" id="new-file-path" placeholder="e.g., Bot/new_script.py" required>
						<button type="submit" class="btn btn-primary">{{ i18n.t('CREATE', lang) }}</button>
					</div>
				</form>
			</div>
			<div class="files-tab-content">
				<div class="file-tree-container">
					<div class="file-tree" id="file-tree"></div>
				</div>
				<div class="editor-container" id="editor-container">
					<h4 id="editor-title"></h4>
					<textarea id="editor" rows="15" cols="60"></textarea>
					<div class="file-actions">
						<button class="btn btn-primary" id="save-file">{{ i18n.t('SAVE', lang) }}</button>
						<button class="btn btn-danger" id="delete-file">{{ i18n.t('DELETE', lang) }}</button>
						<button class="btn btn-warning" id="reload-file" style="display: none;">{{ i18n.t('RELOAD', lang) }}</button>
					</div>
				</div>
			</div>
		</div>
		<div class="tab-pane fade" id="install">
			<h3>{{ i18n.t('INSTALL_TITLE', lang) }}</h3>
			<div class="install-form">
				<form method="POST" action="{{ url_for('install', lang=lang) }}">
					{% for field in fields %}
						<div class="form-group mb-3">
							<label for="{{ field.key }}">{{ field.label }}</label>
							<input type="text" id="{{ field.key }}" name="{{ field.key }}" class="form-control" value="{{ field.value }}">
							<div class="form-check mt-2">
								<input type="checkbox" class="form-check-input" id="{{ field.key }}_use_env" name="{{ field.key }}_use_env" {{ 'checked' if field.use_env else '' }}>
								<label class="form-check-label" for="{{ field.key }}_use_env">{{ i18n.t('USE_ENV', lang) }}</label>
								<small class="text-muted">{{ i18n.t('TOOLTIP_ENV', lang) }}</small>
							</div>
						</div>
					{% endfor %}
					<div class="form-group mb-3">
						<label for="admin_username">{{ i18n.t('ADMIN_USERNAME', lang) }}</label>
						<input type="text" id="admin_username" name="admin_username" class="form-control" value="admin">
					</div>
					<div class="form-group mb-3">
						<label for="admin_password">{{ i18n.t('ADMIN_PASSWORD', lang) }}</label>
						<input type="text" id="admin_password" name="admin_password" class="form-control" value="password123">
					</div>
					<button type="submit" class="btn btn-primary">{{ i18n.t('INSTALL_SUBMIT', lang) }}</button>
				</form>
			</div>
			<div class="install-messages">
				{% for message in messages %}
					<div class="error">{{ message }}</div>
				{% endfor %}
			</div>
		</div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/python.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/xml.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/lib/codemirror.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/python/python.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/javascript/javascript.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/css/css.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/yaml/yaml.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/sql/sql.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/markdown/markdown.min.js"></script>
	<script>// Define global variables for githubInfo and lang
const githubInfo = {
	baseUrl: '{{ github_info.url }}',
	username: '{{ github_info.username }}',
	repo: '{{ github_info.repo }}'
};
const lang = '{{ lang }}';
	// Particles.js initialization
	particlesJS('particles-js', {
		"particles": {
			"number": {
				"value": 80,
				"density": {
					"enable": true,
					"value_area": 800
				}
			},
			"color": {
				"value": "#ffffff"
			},
			"shape": {
				"type": "circle"
			},
			"opacity": {
				"value": 0.5,
				"random": true,
				"anim": {
					"enable": true,
					"speed": 1,
					"opacity_min": 0.1,
					"sync": false
				}
			},
			"size": {
				"value": 3,
				"random": true,
				"anim": {
					"enable": true,
					"speed": 2,
					"size_min": 0.1,
					"sync": false
				}
			},
			"line_linked": {
				"enable": true,
				"distance": 150,
				"color": "#ffffff",
				"opacity": 0.4,
				"width": 1
			},
			"move": {
				"enable": true,
				"speed": 2,
				"direction": "none",
				"random": true,
				"straight": false,
				"out_mode": "out",
				"bounce": false,
				"attract": {
					"enable": true,
					"rotateX": 600,
					"rotateY": 1200
				}
			}
		},
		"interactivity": {
			"detect_on": "canvas",
			"events": {
				"onhover": {
					"enable": true,
					"mode": "grab"
				},
				"onclick": {
					"enable": true,
					"mode": "push"
				},
				"resize": true
			},
			"modes": {
				"grab": {
					"distance": 140,
					"line_linked": {
						"opacity": 1
					}
				},
				"push": {
					"particles_nb": 4
				}
			}
		},
		"retina_detect": true
	});

document
	.querySelectorAll('.promote-credits-form')
	.forEach(form => {
		form.style.display = 'flex';
		form.style.gap = '10px';
		form
			.querySelector('input[type="number"]')
			.style
			.width = '65%';
		form
			.querySelector('input[type="number"]')
			.style
			.backgroundColor = '#2a2a2a';
		form
			.querySelector('input[type="number"]')
			.style
			.color = '#fff';
		form
			.querySelector('input[type="number"]')
			.style
			.border = '1px solid #48ff00';
		form
			.querySelector('button')
			.style
			.width = '33%';
		form
			.querySelector('button')
			.style
			.padding = '5px 10px';
	});

document
	.querySelectorAll('.toggle-blacklist-form, .toggle-beta-tester-form')
	.forEach(form => {
		form.style.display = 'inline-block';
		form
			.querySelector('button')
			.style
			.padding = '5px 10px';
	});

// GitHub-related functionality
let allRepos = [];
let currentPage = 1;
let reposPerPage = 25;

function githubMarkdownToHtml(markdown) {
	const container = document.createElement('div');
	marked.setOptions({
		gfm: true,
		breaks: true,
		tables: true,
		pedantic: false,
		sanitize: false,
		smartLists: true,
		smartypants: false,
		highlight: function(code, lang) {
			if (typeof hljs !== 'undefined' && lang) {
				try {
					return hljs
						.highlight(code, {
							language: lang
						})
						.value;
				} catch (e) {
					console.warn(`Error highlighting ${lang} code:`, e);
				}
			}
			return code;
		}
	});
	container.innerHTML = marked.parse(markdown);
	postProcessHtml(container);
	return container.innerHTML;
}

function postProcessHtml(container) {
	container
		.querySelectorAll('pre')
		.forEach(pre => {
			pre
				.classList
				.add('github-markdown-pre');
			const code = pre.querySelector('code');
			if (code)
				code.classList.add('github-markdown-code');
		});
	container
		.querySelectorAll('table')
		.forEach(table => {
			table
				.classList
				.add('github-markdown-table');
		});
	container
		.querySelectorAll('h1, h2, h3, h4, h5, h6')
		.forEach(header => {
			const id = header
				.textContent
				.toLowerCase()
				.replace(/[^\w\u4e00-\u9fa5]+/g, '-')
				.replace(/^-+|-+$/g, '');
			header.id = id;
			const anchor = document.createElement('a');
			anchor.className = 'github-markdown-header-anchor';
			anchor.href = `#${id}`;
			anchor.innerHTML = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" width="16"><path fill-ru' +
				'le="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 ' +
				'0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 ' +
				'1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2' +
				'-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.4' +
				'5 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>';
			header.prepend(anchor);
		});
}

function ToggleReadMe(repoName, fullName) {
	const readmeContainer = document.getElementById(`readme-${repoName}`);
	if (readmeContainer.style.display === 'none') {
		readmeContainer.style.display = 'block';
	} else {
		readmeContainer.style.display = 'none';
	}
}

async function fetchAndDisplayReadme(repoName, fullName) {
	const readmeContainer = document.getElementById(`readme-${repoName}`);
	try {
		const response = await fetch(`https://raw.githubusercontent.com/${fullName}/main/README.md`);
		if (!response.ok) {
			throw new Error(`Failed to fetch README: ${response.status}`);
		}
		let markdown = await response.text();
		markdown = convertRelativeUrls(markdown, fullName);
		const html = githubMarkdownToHtml(markdown);
		const modalHTML = `
					<div class="readme-modal-overlay" onclick="ToggleReadMe('${repoName}')">
						<div class="readme-modal-content" onclick="event.stopPropagation()">
							<div class="readme-modal-body">${html}</div>
						</div>
					</div>
				`;
		readmeContainer.innerHTML = modalHTML;
		readmeContainer.style.display = 'none';
		processImagesAndLinks(readmeContainer, fullName);
		if (typeof hljs !== 'undefined') {
			document
				.querySelectorAll('.readme-modal-body pre code')
				.forEach(block => {
					hljs.highlightElement(block);
				});
		}
	} catch (error) {
		readmeContainer.innerHTML = `
					<div class="readme-modal-overlay" onclick="ToggleReadMe('${repoName}')">
						<div class="readme-modal-content" onclick="event.stopPropagation()">
							<div class="readme-modal-body">
								<p>{{ i18n.t('README_ERROR', lang) }} ${repoName}</p>
								<p>${error.message}</p>
							</div>
						</div>
					</div>
				`;
		readmeContainer.style.display = 'none';
	}
}

function convertRelativeUrls(markdown, fullName) {
	markdown = markdown.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, altText, path) => {
		if (!path.startsWith('http') && !path.startsWith('data:')) {
			if (path.startsWith('/')) {
				path = `https://raw.githubusercontent.com/${fullName}/main${path}`;
			} else {
				path = `https://raw.githubusercontent.com/${fullName}/main/${path}`;
			}
		}
		return `![${altText}](${path})`;
	});
	markdown = markdown.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, path) => {
		if (!path.startsWith('http') && !path.startsWith('#') && !path.startsWith('mailto:')) {
			if (path.startsWith('/')) {
				path = `https://github.com/${fullName}/blob/main${path}`;
			} else {
				path = `https://github.com/${fullName}/blob/main/${path}`;
			}
		}
		return `[${text}](${path})`;
	});
	return markdown;
}

function processImagesAndLinks(container, fullName) {
	container
		.querySelectorAll('img')
		.forEach(img => {
			const src = img.getAttribute('src');
			if (src && !src.startsWith('http') && !src.startsWith('data:')) {
				const absoluteSrc = src.startsWith('/') ?
					`https://raw.githubusercontent.com/${fullName}/main${src}` :
					`https://raw.githubusercontent.com/${fullName}/main/${src}`;
				img.setAttribute('src', absoluteSrc);
			}
		});
	container
		.querySelectorAll('a')
		.forEach(a => {
			const href = a.getAttribute('href');
			if (href && !href.startsWith('http') && !href.startsWith('#') && !href.startsWith('mailto:')) {
				const absoluteHref = href.startsWith('/') ?
					`https://github.com/${fullName}/blob/main${href}` :
					`https://github.com/${fullName}/blob/main/${href}`;
				a.setAttribute('href', absoluteHref);
				a.setAttribute('target', '_blank');
			}
		});
}

function getBasePath() {
	return githubInfo
		.baseUrl
		.endsWith('/') ?
		githubInfo.baseUrl :
		githubInfo.baseUrl + '/';
}

async function fetchTrafficData(repoName) {
	try {
		const basePath = getBasePath();
		const [viewsRes,
			clonesRes
		] = await Promise.all([
			fetch(`${basePath}/data/repos/${encodeURIComponent(repoName)}/views.json`),
			fetch(`${basePath}/data/repos/${encodeURIComponent(repoName)}/clones.json`)
		]);
		if (!viewsRes.ok) {
			console.warn(`Views data not found for ${repoName}`);
			return {
				views: {
					views: []
				}
			};
		}
		if (!clonesRes.ok) {
			console.warn(`Clones data not found for ${repoName}`);
			return {
				clones: {
					clones: []
				}
			};
		}
		const views = await viewsRes.json();
		const clones = await clonesRes.json();

		// YENİ EKLENEN KOD: Verileri birleştir ve işle
		views.views = mergeDuplicateDates(views.views);
		clones.clones = mergeDuplicateDates(clones.clones);
		const trafficData = {
			views: views || {
				views: []
			},
			clones: clones || {
				clones: []
			}
		};
		if (!validateTrafficData(trafficData)) {
			throw new Error('Invalid data structure');
		}
		return trafficData;
	} catch (error) {
		console.error(`Error loading traffic data for ${repoName}:`, error);
		return {
			views: {
				views: []
			},
			clones: {
				clones: []
			}
		};
	}
}

async function fetchAllRepos() {
	try {
		const basePath = getBasePath();
		const response = await fetch(`${basePath}data/repo-info.json`);
		let data;
		if (!response.ok) {
			const fallbackUrl = `https://raw.githubusercontent.com/${githubInfo.username}/${githubInfo.repo}/main/data/repo-info.json`;
			const fallbackResponse = await fetch(fallbackUrl);
			if (!fallbackResponse.ok) {
				throw new Error('Repository list not found');
			}
			data = await fallbackResponse.json();
		} else {
			data = await response.json();
		}
		return Array.isArray(data) ?
			{
				repositories: data
			} :
			data;
	} catch (error) {
		console.error('Error loading repositories:', error);
		showInfoBox();
		return {
			repositories: []
		};
	}
}

function validateTrafficData(data) {
	if (!data)
		return false;
	if (data.views && !Array.isArray(data.views.views))
		return false;
	if (data.clones && !Array.isArray(data.clones.clones))
		return false;
	return true;
}

function mergeDuplicateDates(data) {
	const merged = {};

	data.forEach(item => {
		const fixedTimestamp = fixTimestamp(item.timestamp);
		const dateKey = fixedTimestamp.split('T')[0];

		if (!merged[dateKey]) {
			merged[dateKey] = {
				...item,
				timestamp: fixedTimestamp
			};
		} else {
			merged[dateKey].count += item.count;
			merged[dateKey].uniques += item.uniques;
		}
	});

	return Object.values(merged);
}

function fixTimestamp(timestamp) {
	// "Above" içerenleri basitçe düzelt
	if (typeof timestamp !== 'string') return '1970-01-01T00:00:00Z';
	return timestamp.replace(' Above', '');
}

function safeDateParse(timestamp) {
	const fixed = fixTimestamp(timestamp);
	const date = new Date(fixed);

	// Fallback için tarih kontrolü
	if (isNaN(date.getTime())) {
		console.warn('Invalid date detected, using fallback:', timestamp);
		const datePart = fixed.split('T')[0] || '1970-01-01';
		return new Date(`${datePart}T00:00:00Z`);
	}

	return date;
}

function formatDate(isoString) {
	try {
		const date = safeDateParse(isoString);
		return date.toLocaleDateString(lang, {
			year: 'numeric',
			month: 'short',
			day: 'numeric'
		});
	} catch (e) {
		console.error('Date formatting error:', e);
		return 'Invalid Date';
	}
}

function fillMissingDates(data, range) {
	if (!data || data.length === 0) return [];

	const dateMap = new Map();

	// Tüm verileri işle ve geçersiz tarihleri düzelt
	data.forEach(item => {
		const fixedTimestamp = fixTimestamp(item.timestamp);
		const date = safeDateParse(fixedTimestamp);
		const dateKey = date.toISOString().split('T')[0];

		dateMap.set(dateKey, {
			...item,
			timestamp: fixedTimestamp
		});
	});

	// Tarih aralığını belirle
	const sortedDates = Array.from(dateMap.keys()).sort();
	if (sortedDates.length === 0) return [];

	const startDate = safeDateParse(sortedDates[0]);
	const endDate = safeDateParse(sortedDates[sortedDates.length - 1]);

	// Eksik tarihleri doldur
	for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
		const dateStr = d.toISOString().split('T')[0];
		if (!dateMap.has(dateStr)) {
			dateMap.set(dateStr, {
				timestamp: `${dateStr}T00:00:00Z`,
				count: 0,
				uniques: 0
			});
		}
	}

	// Sıralı ve doldurulmuş veriyi döndür
	return Array.from(dateMap.values()).sort((a, b) => {
		return safeDateParse(a.timestamp) - safeDateParse(b.timestamp);
	});
}

function createChart(canvasId, label, data, labels, total) {
	const ctx = document.getElementById(canvasId);
	if (!ctx)
		return;
	if (data.length === 0) {
		ctx.parentElement.innerHTML = `<p>{{ i18n.t('NO_DATA', lang) }}</p>`;
		return;
	}
	return new Chart(ctx, {
		type: 'line',
		data: {
			labels: labels,
			datasets: [{
				label: `${label} ({{ i18n.t('TOTAL', lang) }}: ${total || 0})`,
				data: data,
				borderColor: '#48ff00',
				backgroundColor: 'rgba(72, 255, 0, 0.2)',
				borderWidth: 2,
				tension: 0.3,
				fill: true
			}]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			plugins: {
				legend: {
					display: true,
					position: 'top',
					labels: {
						color: '#fff'
					}
				}
			},
			scales: {
				y: {
					beginAtZero: true,
					ticks: {
						color: '#fff'
					},
					grid: {
						color: 'rgba(255, 255, 255, 0.2)'
					}
				},
				x: {
					ticks: {
						color: '#fff',
						maxRotation: 45,
						minRotation: 45
					},
					grid: {
						color: 'rgba(255, 255, 255, 0.1)'
					}
				}
			}
		}
	});
}

function showError(message) {
	const container = document.getElementById('charts-container');
	container.innerHTML = `<div class="error">${message}</div>`;
}

function showInfoBox() {
	document
		.getElementById('info-container')
		.innerHTML = `<div class="info-box">{{ i18n.t('INFO_BOX', lang) }}</div>`;
}

function setupPagination(totalRepos, reposPerPage) {
	const totalPages = Math.ceil(totalRepos / reposPerPage);
	const paginationDiv = document.getElementById('pagination');
	paginationDiv.innerHTML = '';
	if (totalPages <= 1)
		return;

	const prevButton = document.createElement('button');
	prevButton.innerHTML = `{{i18n.t('PREVIOUS_PAGE', lang)}}`;
	prevButton.disabled = currentPage === 1;
	prevButton.addEventListener('click', () => {
		if (currentPage > 1) {
			currentPage -= 1;
			displayRepos();
		}
	});
	paginationDiv.appendChild(prevButton);

	const maxVisiblePages = 5;
	let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
	let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
	if (endPage - startPage + 1 < maxVisiblePages) {
		startPage = Math.max(1, endPage - maxVisiblePages + 1);
	}

	for (let i = startPage; i <= endPage; i++) {
		const pageButton = document.createElement('button');
		pageButton.textContent = i;
		if (i === currentPage)
			pageButton.classList.add('active');
		pageButton.addEventListener('click', () => {
			currentPage = i;
			displayRepos();
		});
		paginationDiv.appendChild(pageButton);
	}

	const nextButton = document.createElement('button');
	nextButton.innerHTML = `{{i18n.t('NEXT_PAGE', lang)}}`;
	nextButton.disabled = currentPage === totalPages;
	nextButton.addEventListener('click', () => {
		if (currentPage < totalPages) {
			currentPage += 1;
			displayRepos();
		}
	});
	paginationDiv.appendChild(nextButton);
	paginationDiv.style.display = 'flex';
}

function filterDataByDateRange(data, range) {
	if (range === 'all') return data;

	const days = parseInt(range) || 30;
	const cutoffDate = new Date();

	// Zaman diliminden bağımsız kesin tarih hesaplama
	cutoffDate.setUTCHours(0, 0, 0, 0); // Gün başlangıcına ayarla
	cutoffDate.setUTCDate(cutoffDate.getUTCDate() - days);

	return data.filter(item => {
		if (!item || !item.timestamp) return false;

		const fixedTimestamp = fixTimestamp(item.timestamp);
		const itemDate = new Date(fixedTimestamp);
		itemDate.setUTCHours(0, 0, 0, 0); // Karşılaştırmayı gün bazında yap

		if (itemDate < cutoffDate) return false;

		return item;
	});
}

async function displayRepos() {
	if (!githubInfo.baseUrl) {
		showInfoBox();
		document
			.getElementById('loading')
			.style
			.display = 'none';
		return;
	}
	if (!allRepos || !allRepos.repositories) {
		showError(`{{i18n.t('ERROR_LOADING_REPOS', lang)}}`);
		return;
	}
	const selectedRange = document
		.getElementById('time-range')
		.value;
	const startIdx = (currentPage - 1) * reposPerPage;
	const endIdx = startIdx + reposPerPage;
	const reposToShow = allRepos
		.repositories
		.slice(startIdx, endIdx);
	const totalPages = Math.ceil(allRepos.repositories.length / reposPerPage);

	document
		.getElementById('charts-container')
		.innerHTML = '';
	document
		.getElementById('loading')
		.textContent = `{{i18n.t('LOADING_REPOS', lang)}}`.replace('(0)', `(${reposToShow.length})`);

	document
		.querySelector('.per-page-selector')
		.style
		.display = 'block';
	document
		.querySelector('.time-range-selector')
		.style
		.display = 'block';
	document
		.querySelector('.info-box')
		.style
		.display = 'none';

	let loadedCount = 0;
	for (const repo of reposToShow) {
		document
			.getElementById('loading')
			.textContent = `{{i18n.t('LOADING_REPOS', lang)}}`.replace('%d', ++loadedCount);
		const trafficData = await fetchTrafficData(repo.name);
		const filteredViews = filterDataByDateRange(trafficData.views.views, selectedRange);
		const filteredClones = filterDataByDateRange(trafficData.clones.clones, selectedRange);
		const completeViews = fillMissingDates(filteredViews, selectedRange);
		const completeClones = fillMissingDates(filteredClones, selectedRange);

		const container = document.createElement('div');
		container.className = 'chart-box';
		const escapedRepoName = repo
			.name
			.replace(/&/g, '&')
			.replace(/</g, '<')
			.replace(/>/g, '>')
			.replace(/"/g, '"')
			.replace(/'/g, '');
		container.innerHTML = `
					<h3>
						<a href="https://github.com/${repo.full_name}" target="_blank">🔗 ${escapedRepoName} {{ i18n.t('REPO_HEADER', lang) }}</a> |
						<a href="https://github.com/${repo.full_name}/zipball/main" target="_top">zip⬇</a> |
						<a href="https://github.com/${repo.full_name}/tarball/main" target="_top">tar⬇</a> |
						<a href="https://github.com/${repo.full_name}/fork" target="_blank">fork🖈</a> |
						<a onclick="ToggleReadMe('${escapedRepoName}', '${repo.full_name}')" id="toggle-${escapedRepoName}">README.md+</a>
					</h3>
					<div id="readme-${escapedRepoName}" style="display:none;"></div>
					<div class="stats-summary">
						<div class="stat-item">
							<span class="stat-label">{{ i18n.t('VIEWS', lang) }}:</span>
							<span class="stat-value">${trafficData.views.count || 0}</span>
						</div>
						<div class="stat-item">
							<span class="stat-label">{{ i18n.t('CLONES', lang) }}:</span>
							<span class="stat-value">${trafficData.clones.count || 0}</span>
						</div>
					</div>
					<div class="chart-row">
						<div class="chart-container">
							<canvas id="views-${escapedRepoName}"></canvas>
						</div>
						<div class="chart-container">
							<canvas id="clones-${escapedRepoName}"></canvas>
						</div>
					</div>
				`.replace('%s', escapedRepoName);
		document
			.getElementById('charts-container')
			.appendChild(container);
		await fetchAndDisplayReadme(repo.name, repo.full_name);

		createChart(`views-${escapedRepoName}`, `{{i18n.t('VIEWS', lang)}}`, completeViews.map(v => v.count), completeViews.map(v => formatDate(v.timestamp)), trafficData.views.count);
		createChart(`clones-${escapedRepoName}`, `{{i18n.t('CLONES', lang)}}`, completeClones.map(c => c.count), completeClones.map(c => formatDate(c.timestamp)), trafficData.clones.count);
	}

	document
		.getElementById('pagination')
		.style
		.display = 'flex';
	document
		.getElementById('loading')
		.textContent = `{{i18n.t('PAGE_STATS', lang)}}`
		.replace('%d', currentPage)
		.replace('%d', totalPages)
		.replace('%d', allRepos.repositories.length);
	setupPagination(allRepos.repositories.length, reposPerPage);
}

// File Tree and Editor
let editor = null;
let currentFilePath = null;

function renderFileTree(files, parentElement) {
	const ul = document.createElement('ul');
	files.forEach(item => {
		const li = document.createElement('li');
		li.className = item.type;
		const a = document.createElement('a');
		a.textContent = item.name;
		if (item.type === 'directory') {
			a.href = '#';
			a.addEventListener('click', (e) => {
				e.preventDefault();
				const children = li.querySelector('ul');
				children.style.display = children.style.display === 'none' ?
					'block' :
					'none';
			});
			li.appendChild(a);
			const childrenUl = document.createElement('ul');
			childrenUl.style.display = 'none';
			renderFileTree(item.children, childrenUl);
			li.appendChild(childrenUl);
		} else {
			a.href = '#';
			a.addEventListener('click', (e) => {
				e.preventDefault();
				loadFile(item.path);
			});
			li.appendChild(a);
		}
		ul.appendChild(li);
	});
	parentElement.appendChild(ul);
}

function loadFile(path) {
	fetch(`/${lang}/files/read`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				path
			})
		})
		.then(response => response.json())
		.then(data => {
			if (data.error) {
				alert(data.error);
				return;
			}
			if (!editor) {
				console.error('Editor not initialized');
				alert('Editor failed to initialize. Please refresh the page.');
				return;
			}
			currentFilePath = path;
			document
				.getElementById('editor-title')
				.textContent = `Editing: ${path}`;
			document
				.getElementById('editor-container')
				.style
				.display = 'block';
			document
				.getElementById('reload-file')
				.style
				.display = 'inline-block'; // Show Reload button
			const modeMap = {
				'.py': 'python',
				'.html': 'htmlmixed',
				'.js': 'javascript',
				'.json': 'javascript',
				'.css': 'css',
				'.yml': 'yaml',
				'.md': 'markdown',
				'.sql': 'sql',
				'.txt': 'text'
			};
			const extension = path
				.substring(path.lastIndexOf('.'))
				.toLowerCase();
			editor.setOption('mode', modeMap[extension] || 'text');
			editor.setValue(data.content);
		})
		.catch(error => {
			console.error('Error loading file:', error);
			alert('Failed to load file');
		});
}

function saveFile() {
	if (!currentFilePath) {
		alert('No file selected');
		return;
	}
	if (!editor) {
		console.error('Editor not initialized');
		alert('Editor failed to initialize');
		return;
	}
	fetch(`/${lang}/files/save`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				path: currentFilePath,
				content: editor.getValue()
			})
		})
		.then(response => response.json())
		.then(data => {
			if (data.error) {
				alert(data.error);
			} else {
				alert(data.message);
			}
		})
		.catch(error => {
			console.error('Error saving file:', error);
			alert('Failed to save file');
		});
}

function reloadFile() {
	if (!currentFilePath) {
		alert('No file selected');
		return;
	}
	fetch(`/${lang}/files/reload`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				path: currentFilePath
			})
		})
		.then(response => response.json())
		.then(data => {
			if (data.error) {
				alert(data.error);
			} else {
				alert(data.message);
			}
		})
		.catch(error => {
			console.error('Error reloading file:', error);
			alert('Failed to reload file');
		});
}

function deleteFile() {
	if (!currentFilePath) {
		alert('No file selected');
		return;
	}
	if (!confirm(`Are you sure you want to delete ${currentFilePath}?`)) {
		return;
	}
	fetch(`/${lang}/files/delete`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				path: currentFilePath
			})
		})
		.then(response => response.json())
		.then(data => {
			if (data.error) {
				alert(data.error);
			} else {
				alert(data.message);
				document
					.getElementById('editor-container')
					.style
					.display = 'none';
				document
					.getElementById('reload-file')
					.style
					.display = 'none';
				currentFilePath = null;
				if (editor) {
					editor.setValue('');
				}
				loadFileTree();
			}
		})
		.catch(error => {
			console.error('Error deleting file:', error);
			alert('Failed to delete file');
		});
}

function loadFileTree() {
	fetch(`/${lang}/files/list`)
		.then(response => response.json())
		.then(data => {
			if (data.error) {
				alert(data.error);
				return;
			}
			const fileTree = document.getElementById('file-tree');
			fileTree.innerHTML = '';
			renderFileTree(data.files, fileTree);
		})
		.catch(error => {
			console.error('Error loading file tree:', error);
			alert('Failed to load file tree');
		});
}

async function main() {
	showInfoBox();
	allRepos = await fetchAllRepos();
	if (!allRepos.repositories || allRepos.repositories.length === 0) {
		showInfoBox();
		return;
	}
	displayRepos(); {% if command_usage %}
	const commandUsage = {{command_usage|tojson}};
	if (commandUsage && commandUsage.length > 0) {
		const ctx = document.createElement('canvas');
		ctx.id = 'command-usage-chart';
		ctx.style.width = '100%';
		ctx.style.height = '300px';
		document
			.querySelector('#commands')
			.insertBefore(ctx, document.querySelector('#commands-table'));
		const labels = commandUsage.map(usage => `/${usage.command}`);
		const percentages = commandUsage.map(usage => usage.percentage);
		new Chart(ctx, {
			type: 'bar',
			data: {
				labels: labels,
				datasets: [{
					label: `{{i18n.t('COMMAND_USAGE_PERCENTAGE', lang)}}`,
					data: percentages,
					backgroundColor: 'rgba(72, 255, 0, 0.2)',
					borderColor: '#48ff00',
					borderWidth: 1
				}]
			},
			options: {
				responsive: true,
				plugins: {
					legend: {
						display: true,
						position: 'top',
						labels: {
							color: '#fff'
						}
					},
					title: {
						display: true,
						text: `{{ i18n.t('COMMAND_USAGE_CHART', lang)}}`,
						color: '#fff'
					}
				},
				scales: {
					y: {
						beginAtZero: true,
						max: 100,
						ticks: {
							color: '#fff',
							callback: value => value + '%'
						},
						grid: {
							color: 'rgba(255, 255, 255, 0.2)'
						}
					},
					x: {
						ticks: {
							color: '#fff'
						},
						grid: {
							color: 'rgba(255, 255, 255, 0.1)'
						}
					}
				}
			}
		});
	} {% endif %}
	loadFileTree();
}

// Hex'i RGB'ye çeviren yardımcı fonksiyon
function hexToRgb(hex) {
	const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
	hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
	const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
	return result ?
		{
			r: parseInt(result[1], 16),
			g: parseInt(result[2], 16),
			b: parseInt(result[3], 16)
		} :
		null;
}

// Debounce function to limit API calls
function forceFocusOnLoad(element) {
    // Aktif sekme kontrolü
    if (document.getElementById('users').classList.contains('active')) {
        if (element !== document.querySelector('input[name=users_search]')) return;
    } else if (document.getElementById('groups').classList.contains('active')) {
        if (element !== document.querySelector('input[name=groups_search]')) return;
    } else if (document.getElementById('products').classList.contains('active')) {
        if (element !== document.querySelector('input[name=products_search]')) return;
    }
    // Doğrudan odaklan
    if (element) {
        element.focus();
        console.log('Odaklanılan input:', element.name);
    } else {
        console.error('Input elementi bulunamadı!');
    }
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

function updateUsers(search, page) {
    const button = document.querySelector('#users-search-form button');
    const searchInput = document.querySelector('input[name=users_search]');
    if (!searchInput) {
        console.error('users_search input bulunamadı!');
        return;
    }
    button.classList.add('loading');
    fetch(`/{{ lang }}/users?search=${encodeURIComponent(search)}&page=${page}`)
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        })
        .then(html => {
            document.getElementById('users').innerHTML = html;
            // Yeni input'u bul
            const newSearchInput = document.querySelector('input[name=users_search]');
            if (newSearchInput) {
                newSearchInput.value = search;
                forceFocusOnLoad(newSearchInput);
            } else {
                console.error('Yeni users_search input bulunamadı!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while fetching users');
        })
        .finally(() => {
            button.classList.remove('loading');
        });
}

// Benzer şekilde updateGroups ve updateProducts için
function updateGroups(search, page) {
    const button = document.querySelector('#groups-search-form button');
    const searchInput = document.querySelector('input[name=groups_search]');
    if (!searchInput) {
        console.error('groups_search input bulunamadı!');
        return;
    }
    button.classList.add('loading');
    fetch(`/{{ lang }}/groups?search=${encodeURIComponent(search)}&page=${page}`)
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        })
        .then(html => {
            document.getElementById('groups').innerHTML = html;
            const newSearchInput = document.querySelector('input[name=groups_search]');
            if (newSearchInput) {
                newSearchInput.value = search;
                forceFocusOnLoad(newSearchInput);
            } else {
                console.error('Yeni groups_search input bulunamadı!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while fetching groups');
        })
        .finally(() => {
            button.classList.remove('loading');
        });
}

function updateProducts(search, filterUserId, page) {
    const button = document.querySelector('#products-search-form button');
    const searchInput = document.querySelector('input[name=products_search]');
    if (!searchInput) {
        console.error('products_search input bulunamadı!');
        return;
    }
    button.classList.add('loading');
    let url = `/{{ lang }}/products?search=${encodeURIComponent(search)}&page=${page}`;
    if (filterUserId) {
        url += `&filter_user_id=${filterUserId}`;
    }
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        })
        .then(html => {
            document.getElementById('products').innerHTML = html;
            const newSearchInput = document.querySelector('input[name=products_search]');
            if (newSearchInput) {
                newSearchInput.value = search;
                forceFocusOnLoad(newSearchInput);
            } else {
                console.error('Yeni products_search input bulunamadı!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while fetching products');
        })
        .finally(() => {
            button.classList.remove('loading');
        });
}

document
	.addEventListener('DOMContentLoaded', function() {// Sekme değiştirme
		document.querySelectorAll('.nav-link').forEach(tab => {
			tab.addEventListener('click', () => {
				document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
				document.querySelectorAll('.tab-pane').forEach(c => c.classList.remove('active', 'show'));
				document.querySelectorAll('.tab-pane').forEach(c => c.classList.add('hide'));
				tab.classList.add('active');
				document.getElementById(tab.getAttribute('data-tab')).classList.add('active', 'show');
				document.getElementById(tab.getAttribute('data-tab')).classList.remove('hide');
				// Sekme değiştiğinde input'a odaklan
				const input = document.querySelector(`input[name=${tab.getAttribute('data-tab')}_search]`);
				if (input) forceFocusOnLoad(input);
			});
		});

		// Arama input'ları için olay dinleyicileri
		const searchFormEvents = ['keyup', 'change'];
		const inputs = {
			users: document.querySelector('input[name=users_search]'),
			groups: document.querySelector('input[name=groups_search]'),
			products: document.querySelector('input[name=products_search]')
		};

		if (inputs.users) {
			searchFormEvents.forEach(event => {
				inputs.users.addEventListener(event, debounce(function(e) {
					if (e.target.matches('input[name="users_search"]')) {
						updateUsers(e.target.value, 1);
					}
				}, 120));
			});
		}

		if (inputs.groups) {
			searchFormEvents.forEach(event => {
				inputs.groups.addEventListener(event, debounce(function(e) {
					if (e.target.matches('input[name="groups_search"]')) {
						updateGroups(e.target.value, 1);
					}
				}, 120));
			});
		}

		if (inputs.products) {
			searchFormEvents.forEach(event => {
				inputs.products.addEventListener(event, debounce(function(e) {
					if (e.target.matches('input[name="products_search"]') || e.target.matches('select[name="filter_user_id"]')) {
						const search = document.querySelector('#products input[name="products_search"]').value;
						const filterUserId = document.querySelector('#products select[name="filter_user_id"]').value;
						updateProducts(search, filterUserId, 1);
					}
				}, 120));
			});
		}
		const searchFormFocusEvents = ['input', 'keydown', 'focus']; // Gereksiz olayları kaldırdık
		const inputs = {
			users: document.querySelector('input[name=users_search]'),
			groups: document.querySelector('input[name=groups_search]'),
			products: document.querySelector('input[name=products_search]')
		};

		// Her input için olay dinleyicileri ekle
		for (const input of Object.values(inputs)) {
			if (input) {
				searchFormFocusEvents.forEach(event => {
					input.addEventListener(event, () => forceFocusOnLoad(input));
				});
			}
		}
		// Initialize CodeMirror editor
		const editorElement = document.getElementById('editor');
		if (editorElement) {
			editor = CodeMirror.fromTextArea(editorElement, {
				lineNumbers: true,
				theme: 'dracula',
				mode: 'python',
				lineWrapping: true
			});
		} else {
			console.error('Editor textarea not found');
		}

		document
			.getElementById('per-page')
			.addEventListener('change', (e) => {
				reposPerPage = parseInt(e.target.value) || 25;
				currentPage = 1;
				displayRepos();
			});
		document
			.getElementById('time-range')
			.addEventListener('change', displayRepos);
		document
			.querySelector('.nav-link[href="#files"]')
			.addEventListener('click', loadFileTree);
		document
			.getElementById('create-file-form')
			.addEventListener('submit', (e) => {
				e.preventDefault();
				const path = document
					.getElementById('new-file-path')
					.value;
				fetch(`/${lang}/files/create`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							path
						})
					})
					.then(response => response.json())
					.then(data => {
						if (data.error) {
							alert(data.error);
						} else {
							alert(data.message);
							document
								.getElementById('new-file-path')
								.value = '';
							loadFileTree();
						}
					})
					.catch(error => {
						console.error('Error creating file:', error);
						alert('Failed to create file');
					});
			});
		document
			.getElementById('save-file')
			.addEventListener('click', saveFile);
		document
			.getElementById('delete-file')
			.addEventListener('click', deleteFile);
		document
			.getElementById('reload-file')
			.addEventListener('click', reloadFile);
		main();
		// Tüm CSS değişkenlerini al
		const rootStyles = getComputedStyle(document.documentElement);
		const cssVars = Array
			.from(rootStyles)
			.filter(prop => prop.startsWith('--bs-') && prop.includes('-bg') && !prop.includes('body-bg'));

		// Yeni stilleri oluştur
		let newStyles = '';
		cssVars.forEach(varName => {
			const value = rootStyles
				.getPropertyValue(varName)
				.trim();
			// RGB formatındaki değişkenleri bul (örneğin, --bs-primary-rgb)
			const rgbVarName = varName.replace('-bg', '-rgb');
			const rgbValue = rootStyles
				.getPropertyValue(rgbVarName)
				.trim();

			if (rgbValue) {
				// RGB varsa, direkt RGBA'ya çevir
				newStyles += `${varName}: rgba(${rgbValue}, 0.5); `;
			} else if (value.startsWith('#')) {
				// Hex ise, RGB'ye çevir ve RGBA yap
				const rgb = hexToRgb(value);
				if (rgb) {
					newStyles += `${varName}: rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.5); `;
				}
			}
		});

		// Yeni stilleri sayfaya ekle
		const styleSheet = document.createElement('style');
		styleSheet.textContent = `:root { ${newStyles} }`;
		document
			.head
			.appendChild(styleSheet);
	});

// Cloudflare challenge scripts
(function() {
	function c() {
		var b = a.contentDocument || a.contentWindow.document;
		if (b) {
			var d = b.createElement('script');
			d.innerHTML = "window.__CF$cv$params={r:'93baf7ddafcb53ee',t:'MTc0NjU2MDYyNC Solid=0MDAwMDA='};" +
				"var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-plat" +
				"form/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a" +
				");";
			b
				.getElementsByTagName('head')[0]
				.appendChild(d);
		}
	}
	if (document.body) {
		var a = document.createElement('iframe');
		a.height = 1;
		a.width = 1;
		a.style.position = 'absolute';
		a.style.top = 0;
		a.style.left = 0;
		a.style.border = 'none';
		a.style.visibility = 'hidden';
		document
			.body
			.appendChild(a);
		if ('loading' !== document.readyState)
			c();
		else if (window.addEventListener)
			document.addEventListener('DOMContentLoaded', c);
		else {
			var e = document.onreadystatechange || function() {};
			document.onreadystatechange = function(b) {
				e(b);
				'loading' !== document.readyState && (document.onreadystatechange = e, c());
			};
		}
	}
})();

(function() {
	function c() {
		var b = a.contentDocument || a.contentWindow.document;
		if (b) {
			var d = b.createElement('script');
			d.innerHTML = "window.__CF$cv$params={r:'93bc436fad194575',t:'MTc0NjU3NDIwNS4wMDAwMDA='};var a=" +
				"document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/s" +
				"cripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
			b
				.getElementsByTagName('head')[0]
				.appendChild(d);
		}
	}
	if (document.body) {
		var a = document.createElement('iframe');
		a.height = 1;
		a.width = 1;
		a.style.position = 'absolute';
		a.style.top = 0;
		a.style.left = 0;
		a.style.border = 'none';
		a.style.visibility = 'hidden';
		document
			.body
			.appendChild(a);
		if ('loading' !== document.readyState)
			c();
		else if (window.addEventListener)
			document.addEventListener('DOMContentLoaded', c);
		else {
			var e = document.onreadystatechange || function() {};
			document.onreadystatechange = function(b) {
				e(b);
				'loading' !== document.readyState && (document.onreadystatechange = e, c());
			};
		}
	}
})();
	</script>
	<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93bd8c7aeec7adde',t:'MTc0NjU4NzY4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93d5e84c58bbad5f',t:'MTc0Njg0MzEwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
	<center>
		<p></p>
		<p><a href="https://ppr.ist/1T9dx8tUT" target="_blank"><img decoding="async" src="https://img.shields.io/badge/{{ i18n.t('DONATE', lang)}}-%E2%9D%A4-blue" alt="{{ i18n.t('USE_PAPARA', lang)}}"></a> <img src="https://img.shields.io/badge/HTML5-E34F26?style=flat&logo=html5&logoColor=white" title="attributes are great">&nbsp;<img src="https://img.shields.io/badge/CSS3-1572B6?style=flat&logo=css3&logoColor=white" title="style is more than make up">&nbsp;<img src="https://img.shields.io/badge/JavaScript-F7DF1E?style=flat&logo=javascript&logoColor=black" title="live Frenkanstein!"></p>
		<p><img decoding="async" src="http://ForTheBadge.com/images/badges/made-with-python.svg"></p>
		<p><a href="http://one.fanclub.rocks/" target="_blank" style="display: inline-flex; align-items: center; padding: 8px 16px; background: linear-gradient(135deg, #ff3366, #ff6633); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: 600; font-size: 15px; text-decoration: none; border-radius: 6px; box-shadow: 0 3px 6px rgba(0,0,0,0.16); transition: all 0.3s ease; letter-spacing: 0.5px;"><svg style="width: 16px; height: 16px; margin-right: 8px; fill: white;" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
					<path d="M19 2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2zm0 16H5V4h14v14zM7 6h10v2H7zm0 4h10v2H7zm0 4h7v2H7z" />
				</svg>One Blog</a>
		</p>
	</center>
</body>
</html>