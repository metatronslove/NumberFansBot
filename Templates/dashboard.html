<!DOCTYPE html>
<html lang="{{ lang }}" {{ 'dir="rtl"' if lang in ['ar', 'he'] else '' }}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ i18n.t('DASHBOARD_TITLE', lang) }}</title>
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/lib/codemirror.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/theme/dracula.min.css">
    <style>
        .file-tree { margin-bottom: 20px; }
        .file-tree ul { list-style: none; padding-left: 20px; }
        .file-tree li { margin: 5px 0; }
        .file-tree .directory > a { font-weight: bold; color: #48ff00; }
        .file-tree .file > a { cursor: pointer; color: #ffffff; }
        .file-tree .file > a:hover { text-decoration: underline; }
        .editor-container { display: none; margin-top: 20px; }
        .CodeMirror { height: 400px; border: 1px solid #48ff00; background: #2a2a2a; color: #fff; }
        .file-actions { margin-top: 10px; }
        .create-file-form { margin-top: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab { cursor: pointer; display: inline-block; padding: 10px 20px; margin-right: 5px; background: #2a2a2a; color: #fff; border-radius: 5px 5px 0 0; }
        .tab.active { background: #48ff00; color: #000; }
        .table-dark { background: #2a2a2a; color: #fff; }
        .form-control { background: #2a2a2a; color: #fff; border: 1px solid #48ff00; }
        .btn-primary { background: #48ff00; color: #000; border: none; }
        .btn-primary:hover { background: #3ce000; }
        .btn-danger { background: #ff4d4d; border: none; }
        .btn-danger:hover { background: #e60000; }
        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    </style>
</head>
<body>
    <div class="particles" id="particles-js"></div>
    <div class="language-switcher">
        <select onchange="window.location.href='/' + this.value">
            {% for code in ['en', 'tr', 'ar', 'he', 'la'] %}
                <option value="{{ code }}" {{ 'selected' if code == lang else '' }}>{{ i18n.t('LANGUAGE_NAME_' + code.upper(), lang) }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="logo-container">
        <div class="logo">NumberFansBot</div>
        <div class="tagline">{{ i18n.t('TAGLINE', lang) }}</div>
    </div>
    <div class="status-container container mt-4">
        <h2>{{ i18n.t('DASHBOARD_TITLE', lang) }}</h2>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert {{ 'alert-success' if category == 'success' else 'alert-danger' }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <div class="tabs">
            {% if command_usage %}
                <div class="tab active" data-tab="commands">{{ i18n.t('COMMANDS_TAB', lang) }}</div>
            {% endif %}
            <div class="tab{% if not command_usage %} active{% endif %}" data-tab="config">{{ i18n.t('CONFIG_TAB', lang) }}</div>
            <div class="tab" data-tab="users">{{ i18n.t('USERS_TAB', lang) }}</div>
            {% if github_info.url %}
                <div class="tab" data-tab="github">{{ i18n.t('GITHUB_TRAFFIC_TAB', lang) }}</div>
            {% endif %}
            <div class="tab" data-tab="files">{{ i18n.t('FILES_TAB', lang) }}</div>
            <div class="link-tab" data-tab="install"><a href="{{ url_for('install', lang=lang) }}" class="btn btn-primary">{{ i18n.t('INSTALL_TAB', lang) }}</a></div>
        </div>
        <div class="tab-content{% if command_usage %} active{% endif %}" id="commands">
            <h2>{{ i18n.t('COMMANDS_TITLE', lang) }}</h2>
            <p>{{ i18n.t('COMMANDS_DESCRIPTION', lang) }}</p>
            {% if command_usage %}
                <table class="table table-dark table-striped" id="commands-table">
                    <thead>
                        <tr>
                            <th>{{ i18n.t('COMMAND_NAME', lang) }}</th>
                            <th>{{ i18n.t('USAGE_COUNT', lang) }}</th>
                            <th>{{ i18n.t('LAST_USED', lang) }}</th>
                            <th>{{ i18n.t('LAST_USER', lang) }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for usage in command_usage %}
                            <tr>
                                <td>/{{ usage['command'] }}</td>
                                <td>{{ usage['count'] }}</td>
                                <td>{{ usage['last_used'].strftime('%Y-%m-%d %H:%M:%S') if usage.get('last_used') else 'N/A' }}</td>
                                <td>{{ usage['last_user_id'] if usage.get('last_user_id') else 'N/A' }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>
        <div class="tab-content{% if not command_usage %} active{% endif %}" id="config">
            <h3>{{ i18n.t('CONFIG_TITLE', lang) }}</h3>
            <form method="POST" action="{{ url_for('save_config_route', lang=lang) }}">
                <h4>{{ i18n.t('STANDARD_SETTINGS', lang) }}</h4>
                {% for field in fields if not field.key.startswith('ai_settings.') %}
                    <div class="mb-3">
                        <label for="{{ field.key }}" class="form-label">{{ field.label }}</label>
                        <input type="text" class="form-control" id="{{ field.key }}" name="{{ field.key }}" value="{{ field.value }}">
                        {% if field.use_env %}
                            <div class="form-check mt-2">
                                <input type="checkbox" class="form-check-input" id="{{ field.key }}_use_env" name="{{ field.key }}_use_env" {{ 'checked' if field.use_env else '' }}>
                                <label class="form-check-label" for="{{ field.key }}_use_env">{{ i18n.t('USE_ENV', lang) }}</label>
                                <small class="text-muted">{{ i18n.t('TOOLTIP_ENV', lang) }}</small>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
                <h4>{{ i18n.t('AI_SETTINGS', lang) }}</h4>
                {% for field in fields if field.key.startswith('ai_settings.') %}
                    <div class="mb-3">
                        <label for="{{ field.key }}" class="form-label">{{ field.label }}</label>
                        <input type="text" class="form-control" id="{{ field.key }}" name="{{ field.key }}" value="{{ field.value }}">
                        {% if field.use_env %}
                            <div class="form-check mt-2">
                                <input type="checkbox" class="form-check-input" id="{{ field.key }}_use_env" name="{{ field.key }}_use_env" {{ 'checked' if field.use_env else '' }}>
                                <label class="form-check-label" for="{{ field.key }}_use_env">{{ i18n.t('USE_ENV', lang) }}</label>
                                <small class="text-muted">{{ i18n.t('TOOLTIP_ENV', lang) }}</small>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
                <h4>AI Models</h4>
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>URL</th>
                            <th>Access Token Env</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for name, model in config.models.items() %}
                            <tr>
                                <td>{{ model.name }}</td>
                                <td>{{ model.url }}</td>
                                <td>{{ model.access_token_env }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('delete_model', lang=lang) }}" style="display:inline;">
                                        <input type="hidden" name="model_name" value="{{ model.name }}">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <h5>Add New Model</h5>
                <form method="POST" action="{{ url_for('add_model', lang=lang) }}">
                    <div class="mb-3">
                        <label for="model_name" class="form-label">Model Name</label>
                        <input type="text" class="form-control" id="model_name" name="model_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="model_url" class="form-label">Model URL</label>
                        <input type="text" class="form-control" id="model_url" name="model_url" required>
                    </div>
                    <div class="mb-3">
                        <label for="access_token_env" class="form-label">Access Token Environment Variable</label>
                        <input type="text" class="form-control" id="access_token_env" name="access_token_env" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Model</button>
                </form>
                <button type="submit" class="btn btn-primary mt-3">{{ i18n.t('SAVE_CONFIG', lang) }}</button>
            </form>
        </div>
        <div class="tab-content" id="users">
            <h3>{{ i18n.t('USERS_TAB', lang) }}</h3>
            <table class="table table-dark">
                <thead>
                    <tr>
                        <th style="text-align: left;">{{ i18n.t('USER_ID', lang) }}</th>
                        <th style="text-align: left;">{{ i18n.t('USERNAME', lang) }}</th>
                        <th style="text-align: center;">{{ i18n.t('BADGES', lang) }}</th>
                        <th style="text-align: center;">{{ i18n.t('CREDITS', lang) }}</th>
                        <th style="text-align: right;">{{ i18n.t('PROMOTE_CREDITS', lang) }}</th>
                        <th style="text-align: right;">{{ i18n.t('BLACKLIST', lang) }}</th>
                        <th style="text-align: right;">{{ i18n.t('BETA_TESTER', lang) }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr>
                            <td style="text-align: left;">{{ user.user_id }}</td>
                            <td style="text-align: left;">{{ user.username }}</td>
                            <td style="text-align: center;">{{ user.badges | safe }}</td>
                            <td style="text-align: center;">{{ user.credits }}</td>
                            <td style="text-align: right;">
                                <form action="{{ url_for('promote_credits', lang=lang) }}" method="POST" class="promote-credits-form">
                                    <input type="hidden" name="user_id" value="{{ user.user_id }}">
                                    <input type="number" name="credits" min="1" placeholder="{{ i18n.t('ENTER_CREDITS', lang) }}" required>
                                    <button type="submit" class="btn btn-primary">{{ i18n.t('SUBMIT', lang) }}</button>
                                </form>
                            </td>
                            <td style="text-align: right;">
                                <form action="{{ url_for('toggle_blacklist', lang=lang) }}" method="POST" class="toggle-blacklist-form">
                                    <input type="hidden" name="user_id" value="{{ user.user_id }}">
                                    <button type="submit" class="btn btn-{{ 'danger' if user.is_blacklisted else 'secondary' }}">
                                        {{ i18n.t('UNBLACKLIST' if user.is_blacklisted else 'BLACKLIST', lang) }}
                                    </button>
                                </form>
                            </td>
                            <td style="text-align: right;">
                                <form action="{{ url_for('toggle_beta_tester', lang=lang) }}" method="POST" class="toggle-beta-tester-form">
                                    <input type="hidden" name="user_id" value="{{ user.user_id }}">
                                    <button type="submit" class="btn btn-{{ 'secondary' if user.is_beta_tester else 'danger' }}">
                                        {{ i18n.t('REVOKE_ACCESS' if user.is_beta_tester else 'GRANT_ACCESS', lang) }}
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="tab-content" id="github">
            {% if not github_info.url %}
                <div class="alert alert-warning">{{ i18n.t('CONFIGURE_GITHUB_URL', lang) }}</div>
            {% else %}
                <div class="time-range-selector">
                    <label>{{ i18n.t('TIME_RANGE', lang) }}:
                        <select id="time-range">
                            <option value="1d">{{ i18n.t('TIME_RANGE_1D', lang) }}</option>
                            <option value="7d">{{ i18n.t('TIME_RANGE_7D', lang) }}</option>
                            <option value="30d" selected>{{ i18n.t('TIME_RANGE_30D', lang) }}</option>
                            <option value="90d">{{ i18n.t('TIME_RANGE_90D', lang) }}</option>
                            <option value="180d">{{ i18n.t('TIME_RANGE_180D', lang) }}</option>
                            <option value="365d">{{ i18n.t('TIME_RANGE_365D', lang) }}</option>
                            <option value="all">{{ i18n.t('TIME_RANGE_ALL', lang) }}</option>
                        </select>
                    </label>
                </div>
                <div class="per-page-selector">
                    <label>{{ i18n.t('PER_PAGE', lang) }}:
                        <select id="per-page">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </label>
                </div>
                <div id="info-container"></div>
                <div id="loading">{{ i18n.t('LOADING', lang) }}</div>
                <div id="charts-container"></div>
                <div class="pagination" id="pagination"></div>
            {% endif %}
        </div>
        <div class="tab-content" id="files">
            <h3>{{ i18n.t('FILES_TAB', lang) }}</h3>
            <div class="file-tree" id="file-tree"></div>
            <div class="create-file-form">
                <h4>{{ i18n.t('CREATE_FILE', lang) }}</h4>
                <form id="create-file-form">
                    <div class="mb-3">
                        <label for="new-file-path" class="form-label">{{ i18n.t('FILE_PATH', lang) }}</label>
                        <input type="text" class="form-control" id="new-file-path" placeholder="e.g., Bot/new_script.py" required>
                    </div>
                    <button type="submit" class="btn btn-primary">{{ i18n.t('CREATE', lang) }}</button>
                </form>
            </div>
            <div class="editor-container" id="editor-container">
                <h4 id="editor-title"></h4>
                <textarea id="editor"></textarea>
                <div class="file-actions">
                    <button class="btn btn-primary" id="save-file">{{ i18n.t('SAVE', lang) }}</button>
                    <button class="btn btn-danger" id="delete-file">{{ i18n.t('DELETE', lang) }}</button>
                </div>
            </div>
        </div>
        <a href="{{ url_for('logout', lang=lang) }}" class="btn btn-secondary mt-3">{{ i18n.t('LOGOUT', lang) }}</a>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.18/lib/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/xml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/lib/codemirror.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/python/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/javascript/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/css/css.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/yaml/yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/sql/sql.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.7/mode/markdown/markdown.min.js"></script>
    <script>
        // Particle background
        particlesJS('particles-js', {
            "particles": {
                "number": {"value": 80, "density": {"enable": true, "value_area": 800}},
                "color": {"value": "#ffffff"},
                "shape": {"type": "circle"},
                "opacity": {"value": 0.5, "random": true, "anim": {"enable": true, "speed": 1, "opacity_min": 0.1, "sync": false}},
                "size": {"value": 3, "random": true, "anim": {"enable": true, "speed": 2, "size_min": 0.1, "sync": false}},
                "line_linked": {"enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.4, "width": 1},
                "move": {"enable": true, "speed": 2, "direction": "none", "random": true, "straight": false, "out_mode": "out", "bounce": false, "attract": {"enable": true, "rotateX": 600, "rotateY": 1200}}
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {"onhover": {"enable": true, "mode": "grab"}, "onclick": {"enable": true, "mode": "push"}, "resize": true},
                "modes": {"grab": {"distance": 140, "line_linked": {"opacity": 1}}, "push": {"particles_nb": 4}}
            },
            "retina_detect": true
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Form styling
        document.querySelectorAll('.promote-credits-form').forEach(form => {
            form.style.display = 'flex';
            form.style.gap = '10px';
            form.querySelector('input[type="number"]').style.width = '65%';
            form.querySelector('input[type="number"]').style.backgroundColor = '#2a2a2a';
            form.querySelector('input[type="number"]').style.color = '#fff';
            form.querySelector('input[type="number"]').style.border = '1px solid #48ff00';
            form.querySelector('button').style.width = '33%';
            form.querySelector('button').style.padding = '5px 10px';
        });

        document.querySelectorAll('.toggle-blacklist-form, .toggle-beta-tester-form').forEach(form => {
            form.style.display = 'inline-block';
            form.querySelector('button').style.padding = '5px 10px';
        });

        // File Tree and Editor
        let editor = null;
        let currentFilePath = null;

        function renderFileTree(files, parentElement, prefix = '') {
            const ul = document.createElement('ul');
            files.forEach(item => {
                const li = document.createElement('li');
                li.className = item.type;
                const a = document.createElement('a');
                a.textContent = item.name;
                if (item.type === 'directory') {
                    a.href = '#';
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        const children = li.querySelector('ul');
                        children.style.display = children.style.display === 'none' ? 'block' : 'none';
                    });
                    li.appendChild(a);
                    const childrenUl = document.createElement('ul');
                    childrenUl.style.display = 'none';
                    renderFileTree(item.children, childrenUl, prefix + '  ');
                    li.appendChild(childrenUl);
                } else {
                    a.href = '#';
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        loadFile(item.path);
                    });
                    li.appendChild(a);
                }
                ul.appendChild(li);
            });
            parentElement.appendChild(ul);
        }

        function loadFile(path) {
            fetch(`/{{ lang }}/files/read`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                currentFilePath = path;
                document.getElementById('editor-title').textContent = `Editing: ${path}`;
                document.getElementById('editor-container').style.display = 'block';
                if (!editor) {
                    editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
                        lineNumbers: true,
                        theme: 'dracula',
                        mode: data.mode
                    });
                } else {
                    editor.setOption('mode', data.mode);
                }
                editor.setValue(data.content);
            })
            .catch(error => {
                console.error('Error loading file:', error);
                alert('Failed to load file');
            });
        }

        function saveFile() {
            if (!currentFilePath) {
                alert('No file selected');
                return;
            }
            fetch(`/{{ lang }}/files/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: currentFilePath, content: editor.getValue() })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error saving file:', error);
                alert('Failed to save file');
            });
        }

        function deleteFile() {
            if (!currentFilePath) {
                alert('No file selected');
                return;
            }
            if (!confirm(`Are you sure you want to delete ${currentFilePath}?`)) {
                return;
            }
            fetch(`/{{ lang }}/files/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: currentFilePath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert(data.message);
                    document.getElementById('editor-container').style.display = 'none';
                    currentFilePath = null;
                    editor.setValue('');
                    loadFileTree();
                }
            })
            .catch(error => {
                console.error('Error deleting file:', error);
                alert('Failed to delete file');
            });
        }

        document.getElementById('create-file-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const path = document.getElementById('new-file-path').value;
            fetch(`/{{ lang }}/files/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert(data.message);
                    document.getElementById('new-file-path').value = '';
                    loadFileTree();
                }
            })
            .catch(error => {
                console.error('Error creating file:', error);
                alert('Failed to create file');
            });
        });

        document.getElementById('save-file').addEventListener('click', saveFile);
        document.getElementById('delete-file').addEventListener('click', deleteFile);

        function loadFileTree() {
            fetch(`/{{ lang }}/files/list`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    const fileTree = document.getElementById('file-tree');
                    fileTree.innerHTML = '';
                    renderFileTree(data.files, fileTree);
                })
                .catch(error => {
                    console.error('Error loading file tree:', error);
                    alert('Failed to load file tree');
                });
        }

        // Load file tree on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadFileTree();
        });

        // GitHub Traffic Functionality
        {% if github_info.url %}
            let allRepos = [];
            let currentPage = 1;
            let reposPerPage = 25;

            const githubInfo = {
                baseUrl: '{{ github_info.url }}',
                username: '{{ github_info.username }}',
                repo: '{{ github_info.repo }}'
            };

            function githubMarkdownToHtml(markdown) {
                const container = document.createElement('div');
                marked.setOptions({
                    gfm: true,
                    breaks: true,
                    tables: true,
                    pedantic: false,
                    sanitize: false,
                    smartLists: true,
                    smartypants: false,
                    highlight: function(code, lang) {
                        if (lang && hljs.getLanguage(lang)) {
                            try {
                                return hljs.highlight(code, { language: lang }).value;
                            } catch (e) {
                                console.warn(`Error highlighting ${lang} code:`, e);
                            }
                        }
                        return code;
                    }
                });
                container.innerHTML = marked.parse(markdown);
                postProcessHtml(container);
                return container.innerHTML;
            }

            function postProcessHtml(container) {
                container.querySelectorAll('pre').forEach(pre => {
                    pre.classList.add('github-markdown-pre');
                    const code = pre.querySelector('code');
                    if (code) code.classList.add('github-markdown-code');
                });
                container.querySelectorAll('table').forEach(table => {
                    table.classList.add('github-markdown-table');
                });
                container.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(header => {
                    const id = header.textContent.toLowerCase().replace(/[^\w\u4e00-\u9fa5]+/g, '-').replace(/^-+|-+$/g, '');
                    header.id = id;
                    const anchor = document.createElement('a');
                    anchor.className = 'github-markdown-header-anchor';
                    anchor.href = `#${id}`;
                    anchor.innerHTML = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>';
                    header.prepend(anchor);
                });
            }

            function ToggleReadMe(repoName, fullName) {
                const readmeContainer = document.getElementById(`readme-${repoName}`);
                if (readmeContainer.style.display === 'none') {
                    readmeContainer.style.display = 'block';
                } else {
                    readmeContainer.style.display = 'none';
                }
            }

            async function fetchAndDisplayReadme(repoName, fullName) {
                const readmeContainer = document.getElementById(`readme-${repoName}`);
                try {
                    const response = await fetch(`https://raw.githubusercontent.com/${fullName}/main/README.md`);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch README: ${response.status}`);
                    }
                    let markdown = await response.text();
                    markdown = convertRelativeUrls(markdown, fullName);
                    const html = githubMarkdownToHtml(markdown);
                    const modalHTML = `
                        <div class="readme-modal-overlay" onclick="ToggleReadMe('${repoName}')">
                            <div class="readme-modal-content" onclick="event.stopPropagation()">
                                <div class="readme-modal-body">${html}</div>
                            </div>
                        </div>
                    `;
                    readmeContainer.innerHTML = modalHTML;
                    readmeContainer.style.display = 'none';
                    processImagesAndLinks(readmeContainer, fullName);
                    document.querySelectorAll('.readme-modal-body pre code').forEach(block => {
                        hljs.highlightElement(block);
                    });
                } catch (error) {
                    readmeContainer.innerHTML = `
                        <div class="readme-modal-overlay" onclick="ToggleReadMe('${repoName}')">
                            <div class="readme-modal-content" onclick="event.stopPropagation()">
                                <div class="readme-modal-body">
                                    <p>{{ i18n.t('README_ERROR', lang) }} ${repoName}</p>
                                    <p>${error.message}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    readmeContainer.style.display = 'none';
                }
            }

            function convertRelativeUrls(markdown, fullName) {
                markdown = markdown.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, altText, path) => {
                    if (!path.startsWith('http') && !path.startsWith('data:')) {
                        if (path.startsWith('/')) {
                            path = `https://raw.githubusercontent.com/${fullName}/main${path}`;
                        } else {
                            path = `https://raw.githubusercontent.com/${fullName}/main/${path}`;
                        }
                    }
                    return `![${altText}](${path})`;
                });
                markdown = markdown.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, path) => {
                    if (!path.startsWith('http') && !path.startsWith('#') && !path.startsWith('mailto:')) {
                        if (path.startsWith('/')) {
                            path = `https://github.com/${fullName}/blob/main${path}`;
                        } else {
                            path = `https://github.com/${fullName}/blob/main/${path}`;
                        }
                    }
                    return `[${text}](${path})`;
                });
                return markdown;
            }

            function processImagesAndLinks(container, fullName) {
                container.querySelectorAll('img').forEach(img => {
                    const src = img.getAttribute('src');
                    if (src && !src.startsWith('http') && !src.startsWith('data:')) {
                        const absoluteSrc = src.startsWith('/')
                            ? `https://raw.githubusercontent.com/${fullName}/main${src}`
                            : `https://raw.githubusercontent.com/${fullName}/main/${src}`;
                        img.setAttribute('src', absoluteSrc);
                    }
                });
                container.querySelectorAll('a').forEach(a => {
                    const href = a.getAttribute('href');
                    if (href && !href.startsWith('http') && !href.startsWith('#') && !href.startsWith('mailto:')) {
                        const absoluteHref = href.startsWith('/')
                            ? `https://github.com/${fullName}/blob/main${href}`
                            : `https://github.com/${fullName}/blob/main/${href}`;
                        a.setAttribute('href', absoluteHref);
                        a.setAttribute('target', '_blank');
                    }
                });
            }

            function getBasePath() {
                return githubInfo.baseUrl.endsWith('/') ? githubInfo.baseUrl : githubInfo.baseUrl + '/';
            }

            async function fetchTrafficData(repoName) {
                try {
                    const basePath = getBasePath();
                    const [viewsRes, clonesRes] = await Promise.all([
                        fetch(`${basePath}data/repos/${encodeURIComponent(repoName)}/views.json`),
                        fetch(`${basePath}data/repos/${encodeURIComponent(repoName)}/clones.json`)
                    ]);
                    if (!viewsRes.ok) {
                        console.warn(`Views data not found for ${repoName}`);
                        return { views: { views: [] } };
                    }
                    if (!clonesRes.ok) {
                        console.warn(`Clones data not found for ${repoName}`);
                        return { clones: { clones: [] } };
                    }
                    const views = await viewsRes.json();
                    const clones = await clonesRes.json();
                    const trafficData = { views: views || { views: [] }, clones: clones || { clones: [] } };
                    if (!validateTrafficData(trafficData)) {
                        throw new Error('Invalid data structure');
                    }
                    return trafficData;
                } catch (error) {
                    console.error(`Error loading traffic data for ${repoName}:`, error);
                    return { views: { views: [] }, clones: { clones: [] } };
                }
            }

            async function fetchAllRepos() {
                try {
                    const basePath = getBasePath();
                    const response = await fetch(`${basePath}data/repo-info.json`);
                    let data;
                    if (!response.ok) {
                        const fallbackUrl = `https://raw.githubusercontent.com/${githubInfo.username}/${githubInfo.repo}/main/data/repo-info.json`;
                        const fallbackResponse = await fetch(fallbackUrl);
                        if (!fallbackResponse.ok) {
                            throw new Error('Repository list not found');
                        }
                        data = await fallbackResponse.json();
                    } else {
                        data = await response.json();
                    }
                    return Array.isArray(data) ? { repositories: data } : data;
                } catch (error) {
                    console.error('Error loading repositories:', error);
                    showInfoBox();
                    return { repositories: [] };
                }
            }

            function validateTrafficData(data) {
                if (!data) return false;
                if (data.views && !Array.isArray(data.views.views)) return false;
                if (data.clones && !Array.isArray(data.clones.clones)) return false;
                return true;
            }

            function formatDate(isoString) {
                const date = new Date(isoString);
                return date.toLocaleDateString('{{ lang }}', { year: 'numeric', month: 'short', day: 'numeric' });
            }

            function fillMissingDates(data, range) {
                if (data.length === 0) return data;
                const dateMap = new Map();
                data.forEach(item => dateMap.set(item.timestamp.split('T')[0], item));
                const sortedDates = [...dateMap.keys()].sort();
                const startDate = new Date(sortedDates[0]);
                const endDate = new Date(sortedDates[sortedDates.length - 1]);
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    if (!dateMap.has(dateStr)) {
                        dateMap.set(dateStr, { timestamp: dateStr, count: 0, uniques: 0 });
                    }
                }
                return [...dateMap.values()].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            }

            function createChart(canvasId, label, data, labels, total) {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return;
                if (data.length === 0) {
                    ctx.parentElement.innerHTML = `<p>{{ i18n.t('NO_DATA', lang) }}</p>`;
                    return;
                }
                return new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${label} ({{ i18n.t('TOTAL', lang) }}: ${total || 0})`,
                            data: data,
                            borderColor: '#48ff00',
                            backgroundColor: 'rgba(72, 255, 0, 0.2)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top', labels: { color: '#fff' } }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255, 255, 255, 0.2)' } },
                            x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255, 255, 255, 0.2)' } }
                        }
                    }
                });
            }

            function showInfoBox() {
                const infoContainer = document.getElementById('info-container');
                infoContainer.innerHTML = `
                    <div class="alert alert-warning">
                        {{ i18n.t('NO_REPOSITORIES', lang) }}
                    </div>
                `;
                document.getElementById('loading').style.display = 'none';
            }

            async function displayRepos(page, timeRange, perPage) {
                const start = (page - 1) * perPage;
                const end = start + perPage;
                const paginatedRepos = allRepos.slice(start, end);

                const chartsContainer = document.getElementById('charts-container');
                chartsContainer.innerHTML = '';

                for (const repo of paginatedRepos) {
                    const repoName = repo.name;
                    const fullName = `${githubInfo.username}/${repoName}`;
                    const trafficData = await fetchTrafficData(repoName);

                    const viewsData = fillMissingDates(trafficData.views.views, timeRange);
                    const clonesData = fillMissingDates(trafficData.clones.clones, timeRange);

                    const viewsLabels = viewsData.map(item => formatDate(item.timestamp));
                    const viewsCounts = viewsData.map(item => item.count);
                    const viewsUniques = viewsData.map(item => item.uniques);
                    const clonesLabels = clonesData.map(item => formatDate(item.timestamp));
                    const clonesCounts = clonesData.map(item => item.count);
                    const clonesUniques = clonesData.map(item => item.uniques);

                    const totalViews = viewsCounts.reduce((a, b) => a + b, 0);
                    const totalClones = clonesCounts.reduce((a, b) => a + b, 0);

                    chartsContainer.innerHTML += `
                        <div class="repo-container">
                            <h3>${repoName}</h3>
                            <button onclick="fetchAndDisplayReadme('${repoName}', '${fullName}'); ToggleReadMe('${repoName}', '${fullName}');" class="btn btn-primary">Show README</button>
                            <div id="readme-${repoName}" style="display: none;"></div>
                            <div class="chart-container">
                                <canvas id="views-chart-${repoName}"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="clones-chart-${repoName}"></canvas>
                            </div>
                        </div>
                    `;

                    createChart(`views-chart-${repoName}`, '{{ i18n.t('VIEWS', lang) }}', viewsCounts, viewsLabels, totalViews);
                    createChart(`clones-chart-${repoName}`, '{{ i18n.t('CLONES', lang) }}', clonesCounts, clonesLabels, totalClones);
                }

                document.getElementById('loading').style.display = 'none';

                const totalPages = Math.ceil(allRepos.length / perPage);
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    pagination.innerHTML += `
                        <button onclick="displayRepos(${i}, '${timeRange}', ${perPage})" class="btn btn-${i === page ? 'primary' : 'secondary'}">${i}</button>
                    `;
                }
            }

            document.getElementById('time-range').addEventListener('change', (e) => {
                reposPerPage = parseInt(document.getElementById('per-page').value);
                displayRepos(1, e.target.value, reposPerPage);
            });

            document.getElementById('per-page').addEventListener('change', (e) => {
                reposPerPage = parseInt(e.target.value);
                displayRepos(1, document.getElementById('time-range').value, reposPerPage);
            });

            async function initGitHubTab() {
                const repoData = await fetchAllRepos();
                allRepos = repoData.repositories || [];
                if (allRepos.length === 0) {
                    showInfoBox();
                    return;
                }
                await displayRepos(1, '30d', reposPerPage);
            }

            document.addEventListener('DOMContentLoaded', () => {
                if (document.querySelector('.tab[data-tab="github"]').classList.contains('active')) {
                    initGitHubTab();
                }
                document.querySelector('.tab[data-tab="github"]').addEventListener('click', () => {
                    if (!allRepos.length) {
                        initGitHubTab();
                    }
                });
            });
        {% endif %}
    </script>
</body>
</html>